<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>STEM Ms. Chang â€” Learning Resources</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- è§£å†³ favicon 404ï¼ˆå†…è”ä¸€ä¸ªç®€æ˜“å›¾æ ‡ï¼‰ -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ”¬</text></svg>'>
  <style>
    :root { --bg:#0b1220; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --brand:#22c55e; --border:#233044; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px;}
    header{display:flex;gap:16px;align-items:center;margin-bottom:16px;}
    .logo{width:48px;height:48px;border-radius:12px;background:#1f2937;display:grid;place-items:center;font-size:28px}
    h1{font-size:22px;margin:0}
    .muted{color:var(--muted)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button,.btn{background:#1f2937;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    button.primary{background:var(--brand);border-color:#16a34a;color:#0b1220;font-weight:600}
    button:disabled{opacity:.6;cursor:not-allowed}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--border);cursor:pointer;background:#0f172a}
    .tab.active{background:#0ea5e9;border-color:#0284c7}
    .grade-bar{display:flex;justify-content:space-between;align-items:center;margin:8px 0 16px}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
    .item{border:1px dashed var(--border);border-radius:12px;padding:12px;background:#0f172a}
    .item b{display:block;margin-bottom:6px}
    .hint{font-size:14px;color:var(--muted)}
    .sep{height:1px;background:var(--border);margin:12px 0}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">ğŸ”¬</div>
    <div>
      <h1>STEM Ms. Chang â€” Learning Resources</h1>
      <div class="muted">STEM Teacher Kâ€“8 Â· Harmony Science Academy Â· Lubbock, TX</div>
    </div>
  </header>

  <div class="card">
    <div class="row">
      <button id="loginBtn" class="primary">Sign in with Google</button>
      <button id="logoutBtn" style="display:none;">Sign out</button>
      <span id="who" class="muted"></span>
    </div>
    <div class="sep"></div>
    <div class="tabs" id="gradeTabs">
      <div class="tab" data-grade="5th">5th Grade</div>
      <div class="tab" data-grade="6th">6th Grade</div>
      <div class="tab" data-grade="7th">7th Grade</div>
      <div class="tab" data-grade="8th">8th Grade</div>
    </div>

    <div class="grade-bar">
      <div class="hint" id="gradeTitle">Select a grade.</div>
      <div class="row" id="adminBar" style="display:none;">
        <input type="file" id="fileInput" />
        <button id="uploadBtn">Upload to this grade</button>
        <button id="mkFolderBtn">ï¼‹ New folder</button>
      </div>
    </div>

    <div id="list" class="list"></div>
    <div id="msg" class="hint"></div>
  </div>

  <p class="hint" style="margin-top:12px">
    Tip: Files are in Firebase Storage under folders <code>5th/</code>, <code>6th/</code>, <code>7th/</code>, <code>8th/</code>.  
    Students must sign in to view & download. Only the admin email can upload/create folders.
  </p>
</div>

<!-- Firebase v10 CDN (æ¨¡å—åŒ–) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getStorage, ref, listAll, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // === ğŸ”§ åªéœ€æŠŠä¸‹é¢è¿™ä¸€æ®µæ”¹æˆä½ çš„é¡¹ç›®é…ç½®ï¼ˆå·²ä¸ºä½ å¡«å¥½ï¼‰ ===
  const firebaseConfig = {
    apiKey: "AIzaSyDELcdhJKPrSVOGROj-yKl5rSGeNst6Z7k",
    authDomain: "chang-stem-class--materials.firebaseapp.com",
    projectId: "chang-stem-class--materials",
    storageBucket: "chang-stem-class--materials.firebasestorage.app", // â† è·Ÿä½  Console é‡Œ gs:// åé¢ä¸€è‡´
    messagingSenderId: "1066269130031",
    appId: "1:1066269130031:web:62b518c60d0c724571f5da",
    measurementId: "G-D4N8JERGV8"
  };
  // ===========================================================

  const app = initializeApp(firebaseConfig);

  // æ˜ç¡®æŒ‡å®šåŒä¸€ä¸ªæ¡¶ï¼ˆå¯é€‰ï¼Œä½†æ›´ç¨³ï¼‰
  const storage = getStorage(app, "gs://chang-stem-class--materials.firebasestorage.app");
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const ADMIN_EMAILS = ["vivien.chang10@gmail.com"];

  // UI refs
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const who = document.getElementById("who");
  const gradeTabs = document.getElementById("gradeTabs");
  const listEl = document.getElementById("list");
  const msgEl = document.getElementById("msg");
  const adminBar = document.getElementById("adminBar");
  const fileInput = document.getElementById("fileInput");
  const uploadBtn = document.getElementById("uploadBtn");
  const mkFolderBtn = document.getElementById("mkFolderBtn");
  const gradeTitle = document.getElementById("gradeTitle");

  let currentUser = null;
  let currentGrade = null;

  // åªåœ¨ç™»å½•ååŠ è½½å†…å®¹
  onAuthStateChanged(auth, (user) => {
    currentUser = user || null;
    if (user) {
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      who.textContent = `Signed in: ${user.email}`;
      // ç®¡ç†å‘˜å¯è§ä¸Šä¼ /æ–°å»ºæŒ‰é’®
      adminBar.style.display = ADMIN_EMAILS.includes(user.email) ? "flex" : "none";
      // é»˜è®¤åŠ è½½ 5th
      selectGrade("5th");
    } else {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      who.textContent = "";
      adminBar.style.display = "none";
      listEl.innerHTML = "";
      gradeTitle.textContent = "Please sign in, then select a grade.";
    }
  });

  loginBtn.onclick = async () => {
    try {
      await signInWithPopup(auth, provider);
    } catch (e) {
      console.error(e);
      alert("Sign-in failed: " + (e?.message || e));
    }
  };

  logoutBtn.onclick = async () => {
    await signOut(auth);
  };

  // åˆ‡æ¢å¹´çº§æ ‡ç­¾
  gradeTabs.addEventListener("click", (e) => {
    const t = e.target.closest(".tab");
    if (!t) return;
    const g = t.dataset.grade;
    selectGrade(g);
    for (const el of gradeTabs.querySelectorAll(".tab")) el.classList.toggle("active", el === t);
  });

  function setMessage(text) {
    msgEl.textContent = text || "";
  }

  async function selectGrade(grade) {
    if (!currentUser) { setMessage("Please sign in first."); return; }
    currentGrade = grade;
    gradeTitle.textContent = `${grade} â€” files & folders`;
    setMessage("Loading...");
    listEl.innerHTML = "";
    try {
      // åˆ—å‡ºè¯¥å¹´çº§æ ¹ç›®å½•çš„æ–‡ä»¶ / å­ç›®å½•
      const baseRef = ref(storage, `${grade}/`);
      const result = await listAll(baseRef);

      // å­ç›®å½•
      for (const p of result.prefixes) {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<b>ğŸ“ ${p.name}/</b><span class="hint">Folder under ${grade}/</span>`;
        listEl.appendChild(div);

        // ï¼ˆå¯é€‰ï¼‰ä¹ŸæŠŠæ¯ä¸ªå­ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ—å‡ºæ¥
        const sub = await listAll(p);
        for (const f of sub.items) {
          const url = await getDownloadURL(f);
          const item = document.createElement("div");
          item.className = "item";
          item.innerHTML = `<b>ğŸ“„ ${p.name}/${f.name}</b><a class="btn" href="${url}" target="_blank" rel="noopener">Download</a>`;
          listEl.appendChild(item);
        }
      }

      // è¯¥å¹´çº§æ ¹ç›®å½•ä¸‹çš„æ–‡ä»¶
      for (const f of result.items) {
        const url = await getDownloadURL(f);
        const item = document.createElement("div");
        item.className = "item";
        item.innerHTML = `<b>ğŸ“„ ${f.name}</b><a class="btn" href="${url}" target="_blank" rel="noopener">Download</a>`;
        listEl.appendChild(item);
      }

      if (!result.items.length && !result.prefixes.length) {
        setMessage("No files yet. (Admins can upload.)");
      } else {
        setMessage("");
      }
    } catch (err) {
      console.error(err);
      // æœªç™»å½•æˆ–è§„åˆ™æ‹’ç»ï¼ŒSDK å¸¸è¡¨ç°å¾—åƒ CORSï¼Œè¿™é‡Œç»™å‡ºç›´è§‚æç¤º
      setMessage("Cannot list files. Make sure you are signed in and Storage rules allow authenticated read.");
    }
  }

  // ç®¡ç†å‘˜ï¼šä¸Šä¼ åˆ°å½“å‰å¹´çº§æ ¹ç›®å½•
  uploadBtn.onclick = async () => {
    try {
      if (!currentUser) return alert("Please sign in first.");
      if (!ADMIN_EMAILS.includes(currentUser.email)) return alert("Only admin can upload.");
      if (!currentGrade) return alert("Select a grade first.");
      const file = fileInput.files?.[0];
      if (!file) return alert("Choose a file first.");

      const fileRef = ref(storage, `${currentGrade}/${file.name}`);
      await uploadBytes(fileRef, file);
      alert("Uploaded!");
      selectGrade(currentGrade);
    } catch (e) {
      console.error(e);
      alert("Upload failed: " + (e?.message || e));
    }
  };

  // ç®¡ç†å‘˜ï¼šæ–°å»ºâ€œæ–‡ä»¶å¤¹â€ï¼ˆç”¨ .keep å ä½ï¼‰
  mkFolderBtn.onclick = async () => {
    try {
      if (!currentUser) return alert("Please sign in first.");
      if (!ADMIN_EMAILS.includes(currentUser.email)) return alert("Only admin can create folders.");
      if (!currentGrade) return alert("Select a grade first.");
      const name = prompt("New folder name (letters/numbers only):");
      if (!name) return;
      const safe = name.trim().replace(/[^a-z0-9-_ ]/gi, "_");
      const blob = new Blob([""], { type: "text/plain" });
      const keepRef = ref(storage, `${currentGrade}/${safe}/.keep`);
      await uploadBytes(keepRef, blob);
      alert(`Folder "${safe}" created.`);
      selectGrade(currentGrade);
    } catch (e) {
      console.error(e);
      alert("Create folder failed: " + (e?.message || e));
    }
  };

  // æ§åˆ¶å°é‡Œæ‰“ä¸ªæ ‡è®°ï¼Œæ–¹ä¾¿ä½ ç¡®è®¤æ¡¶å
  console.log("Using bucket:", firebaseConfig.storageBucket);
</script>
</body>
</html>
