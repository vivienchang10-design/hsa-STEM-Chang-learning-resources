<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STEM Ms. Chang ‚Äì Learning Resources</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Ctext y='24' font-size='24'%3Eüî¨%3C/text%3E%3C/svg%3E">
  <style>
    :root{--bg:#f7f7fb;--fg:#222;--muted:#6b7280;--card:#fff;--border:#e5e7eb;--brand:#2563eb;--warn:#b91c1c;--note:#fff8e1;--note-b:#fde68a}
    *{box-sizing:border-box}
    body{font-family:system-ui,Arial,Helvetica,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
    header{background:#1f2937;color:#fff;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title{font-weight:700}
    .sub{opacity:.9;font-size:14px}
    .btn{padding:8px 12px;border:0;border-radius:10px;cursor:pointer}
    .primary{background:var(--brand);color:#fff}
    .ghost{background:#fff;color:#111;border:1px solid var(--border)}
    main{max-width:960px;margin:24px auto;padding:0 16px}
    .hidden{display:none}
    .grades{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px}
    .muted{color:var(--muted)}
    a{color:var(--brand);text-decoration:none}
    a:hover{text-decoration:underline}
    .folder{font-weight:600}
    .file{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px dashed #eee}
    .file:last-child{border-bottom:0}
    .note{background:var(--note);border:1px solid var(--note-b);border-radius:10px;padding:10px}
    .warn{background:#fee2e2;border:1px solid #fecaca;color:var(--warn);border-radius:10px;padding:10px}
    code.badge{background:#eef2ff;padding:2px 6px;border-radius:6px;border:1px solid #c7d2fe}
    .disabled{opacity:.6;pointer-events:none}
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">STEM Ms. Chang</div>
      <div class="sub">K‚Äì8 STEM ‚Ä¢ Harmony Science Academy ‚Ä¢ Lubbock, TX</div>
    </div>
    <div>
      <button id="loginBtn" class="btn primary">Sign in with Google</button>
      <button id="logoutBtn" class="btn ghost hidden">Sign out</button>
    </div>
  </header>

  <main>
    <div class="card">
      <div>Current site origin: <code class="badge" id="origin"></code></div>
      <div class="muted" style="margin-top:6px">
        This exact domain must be in Firebase ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains.
      </div>
    </div>

    <div id="domainWarn" class="card hidden">
      <div class="warn">
        You are opening a Vercel preview domain which is usually NOT authorized yet.
        Please open the production domain instead:
        <a id="prodLink" href="#">go to production</a>.
        <div class="muted" style="margin-top:6px">
          Or add this preview domain to Authorized domains temporarily, then refresh.
        </div>
      </div>
    </div>

    <div id="needAuth" class="card">
      <div class="note">Please sign in with Google to view and download class materials.</div>
    </div>

    <div id="authedArea" class="hidden">
      <div class="card">
        <div id="userInfo" class="muted">Signed in</div>
        <div class="grades" id="gradeBar">
          <button class="btn ghost" data-grade="5th">5th Grade</button>
          <button class="btn ghost" data-grade="6th">6th Grade</button>
          <button class="btn ghost" data-grade="7th">7th Grade</button>
          <button class="btn ghost" data-grade="8th">8th Grade</button>
        </div>
        <div id="status" class="muted"></div>
      </div>

      <div id="list" class="card">
        <div class="muted">Select a grade above to list files.</div>
      </div>
    </div>
  </main>

  <!-- Firebase v11 Ê®°ÂùóÂåñ SDKÔºàCDNÔºâ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getStorage, ref, listAll, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // ======= ÈÖçÁΩÆÔºàstorageBucket ÂøÖÈ°ªÊòØ appspot.com ÁªìÂ∞æÔºâ=======
    const firebaseConfig = {
      apiKey: "AIzaSyDELcdhJKPrSVOGROj-yKl5rSGeNst6Z7k",
      authDomain: "chang-stem-class--materials.firebaseapp.com",
      projectId: "chang-stem-class--materials",
      storageBucket: "chang-stem-class--materials.appspot.com",
      messagingSenderId: "1066269130031",
      appId: "1:1066269130031:web:62b518c60d0c724571f5da",
      measurementId: "G-D4N8JERGV8"
    };

    // ======= ÂàùÂßãÂåñ =======
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    auth.useDeviceLanguage();
    const provider = new GoogleAuthProvider();
    const storage = getStorage(app);

    // ÁôªÂΩïÊåÅ‰πÖÂåñ
    setPersistence(auth, browserLocalPersistence).catch(() => {});

    // ======= DOM =======
    const originEl = document.getElementById("origin");
    const domainWarn = document.getElementById("domainWarn");
    const prodLink = document.getElementById("prodLink");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const needAuth = document.getElementById("needAuth");
    const authedArea = document.getElementById("authedArea");
    const userInfo = document.getElementById("userInfo");
    const listEl = document.getElementById("list");
    const statusEl = document.getElementById("status");
    const gradeBar = document.getElementById("gradeBar");

    // ======= ÂüüÂêçÊ£ÄÊü•ÔºöÈ¢ÑËßàÂüüÂêç‰ºöÊã¶Êà™ÔºåÈÅøÂÖçÂèëËµ∑ Storage ËØ∑Ê±ÇÂØºËá¥ CORS ÂÅáË±° =======
    const PROD_HOST = "hsa-stem-chang-learning-resources.vercel.app";
    const ON_PROD = location.host === PROD_HOST;

    originEl.textContent = location.host;
    prodLink.href = `https://${PROD_HOST}`;

    function setGradesEnabled(enabled) {
      gradeBar.querySelectorAll("button").forEach(btn => {
        if (enabled) btn.classList.remove("disabled");
        else btn.classList.add("disabled");
      });
    }

    if (!ON_PROD) {
      // ÈùûÊ≠£ÂºèÂüüÂêçÔºöÁªôÂá∫ÊèêÁ§∫Âπ∂Á¶ÅÁî®Âπ¥Á∫ßÊåâÈíÆÔºåÁõ¥Âà∞‰Ω†ÊääËØ•ÂüüÂêçÂä†ÂÖ• Authorized domains
      domainWarn.classList.remove("hidden");
      setGradesEnabled(false);
    } else {
      domainWarn.classList.add("hidden");
      setGradesEnabled(true);
    }

    // ======= ÁôªÂΩï / ÁôªÂá∫ =======
    loginBtn.onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error(err);
        alert("Sign-in failed: " + (err && err.message ? err.message : err));
      }
    };

    logoutBtn.onclick = async () => {
      try {
        await signOut(auth);
      } catch (err) {
        console.error(err);
      }
    };

    // ======= ÁôªÂΩïÁä∂ÊÄÅÂàáÊç¢ =======
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        needAuth.classList.add("hidden");
        authedArea.classList.remove("hidden");
        userInfo.textContent = "Signed in as " + user.email;
      } else {
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        needAuth.classList.remove("hidden");
        authedArea.classList.add("hidden");
        listEl.innerHTML = "<div class='muted'>Sign in first.</div>";
      }
    });

    // ======= ÁªëÂÆöÂπ¥Á∫ßÁÇπÂáªÔºàÂèåÈáç‰øùÊä§ÔºöÊú™ÁôªÂΩïÊàñÈùûÊ≠£ÂºèÂüüÂêçÈÉΩ‰∏çËØ∑Ê±ÇÔºâ=======
    gradeBar.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", async () => {
        if (!auth.currentUser) {
          alert("Please sign in first.");
          return;
        }
        if (!ON_PROD) {
          alert("This is a Vercel preview domain. Add this domain to Firebase Authorized domains, or open the production link shown above.");
          return;
        }
        const grade = btn.getAttribute("data-grade");
        await renderGrade(grade);
      });
    });

    // ======= ÂàóË°®Ê∏≤Êüì =======
    async function renderGrade(grade) {
      statusEl.textContent = "Loading‚Ä¶";
      listEl.innerHTML = "";
      try {
        // Âº∫Âà∂Âà∑Êñ∞ ID TokenÔºåÁ°Æ‰øù Storage ÁúãÂà∞ÁöÑÊòØÂ∑≤ÁôªÂΩïÁä∂ÊÄÅ
        if (auth.currentUser && auth.currentUser.getIdToken) {
          await auth.currentUser.getIdToken(true);
        }

        const rootRef = ref(storage, grade + "/");
        const res = await listAll(rootRef);
        const container = document.createElement("div");

        if (res.prefixes.length) {
          const h = document.createElement("div");
          h.className = "folder";
          h.textContent = "Folders";
          container.appendChild(h);
          res.prefixes.forEach(p => {
            const row = document.createElement("div");
            row.className = "file";
            row.innerHTML = "<span>üìÅ " + p.name + "/</span>" +
              "<a href='#' data-sub='" + p.fullPath + "'>Open</a>";
            container.appendChild(row);
          });
        }

        if (res.items.length) {
          const h2 = document.createElement("div");
          h2.className = "folder";
          h2.style.marginTop = "8px";
          h2.textContent = "Files";
          container.appendChild(h2);

          for (const itemRef of res.items) {
            const url = await getDownloadURL(itemRef);
            const row = document.createElement("div");
            row.className = "file";
            row.innerHTML = "<span>üìÑ " + itemRef.name + "</span>" +
              "<a href='" + url + "' download>Download</a>";
            container.appendChild(row);
          }
        }

        if (!res.prefixes.length && !res.items.length) {
          container.innerHTML = "<div class='muted'>No files yet in <strong>" + grade + "</strong>.</div>";
        }

        listEl.appendChild(container);

        listEl.querySelectorAll("[data-sub]").forEach(a => {
          a.addEventListener("click", async (e) => {
            e.preventDefault();
            const sub = a.getAttribute("data-sub");
            await renderFolder(sub);
          });
        });

        statusEl.textContent = "";
      } catch (e) {
        console.error(e);
        statusEl.textContent =
          "Failed to load. Check Authorized domains (use production domain), App Check must be Unenforced for Storage, and Storage rules require login.";
      }
    }

    async function renderFolder(path) {
      statusEl.textContent = "Loading " + path + "‚Ä¶";
      listEl.innerHTML = "";
      try {
        if (auth.currentUser && auth.currentUser.getIdToken) {
          await auth.currentUser.getIdToken(true);
        }

        const res = await listAll(ref(storage, path + "/"));
        const container = document.createElement("div");
        const h = document.createElement("div");
        h.className = "folder";
        h.textContent = path;
        container.appendChild(h);

        for (const itemRef of res.items) {
          const url = await getDownloadURL(itemRef);
          const row = document.createElement("div");
          row.className = "file";
          row.innerHTML = "<span>üìÑ " + itemRef.name + "</span>" +
            "<a href='" + url + "' download>Download</a>";
          container.appendChild(row);
        }

        if (!res.items.length) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = "No files in this folder.";
          container.appendChild(empty);
        }

        listEl.appendChild(container);
        statusEl.textContent = "";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Failed to open folder.";
      }
    }
  </script>
</body>
</html>
