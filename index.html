<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>STEM Ms. Chang – Learning Resources</title>
  <!-- Fix COOP for OAuth popups/redirects on Vercel -->
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups" />
  <link rel="icon" href="/favicon.ico" sizes="any">
  <style>
    :root{--bg:#0f172a;--card:#111827;--fg:#e5e7eb;--muted:#9ca3af;--accent:#38bdf8;--ok:#34d399}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header,main,footer{max-width:960px;margin:0 auto;padding:20px}
    h1{margin:16px 0 6px;font-size:clamp(24px,5vw,40px)}
    .card{background:rgba(17,24,39,.85);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button,select,input[type=file]{background:var(--accent);color:#05253a;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;color:var(--fg);border:1px solid rgba(255,255,255,.18)}
    .hidden{display:none}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:10px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    a.file{display:flex;gap:10px;align-items:center;padding:12px;border-radius:12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08)}
    a.file:hover{border-color:rgba(56,189,248,.6)}
    .tag{display:inline-block;margin-top:10px;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted)}
  </style>
  <!-- Firebase SDKs (auth + storage only) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getStorage, ref, listAll, getDownloadURL, uploadBytes } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js';

    // Your Firebase config (corrected storageBucket domain)
    const firebaseConfig = {
      apiKey: "AIzaSyDELcdhJKPrSVOGROj-yKl5rSGeNst6Z7k",
      authDomain: "chang-stem-class--materials.firebaseapp.com",
      projectId: "chang-stem-class--materials",
      storageBucket: "chang-stem-class--materials.appspot.com",
      messagingSenderId: "1066269130031",
      appId: "1:1066269130031:web:62b518c60d0c724571f5da",
      measurementId: "G-D4N8JERGV8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);

    const ADMIN_EMAIL = 'xchang@harmonytx.org';
    const ALLOWED_DOMAIN = 'harmonytx.org';

    // --- UI elements ---
    const loginBox = () => document.getElementById('loginBox');
    const content = () => document.getElementById('content');
    const admin = () => document.getElementById('admin');
    const welcome = () => document.getElementById('welcome');
    const fileList = () => document.getElementById('fileList');

    // Use redirect-based sign-in (avoids popup/COOP issues)
    const provider = new GoogleAuthProvider();
    async function login(){
      // Prevent duplicate redirects
      if (sessionStorage.getItem('authRedirecting')) return;
      sessionStorage.setItem('authRedirecting','1');
      await signInWithRedirect(auth, provider);
    }
    async function logout(){ await signOut(auth); }

    // Handle redirect result on page load
    getRedirectResult(auth).catch(err => {
      // Common causes: unauthorized domain, blocked third-party cookies
      console.warn('Redirect error:', err.code, err.message);
    }).finally(() => {
      sessionStorage.removeItem('authRedirecting');
    });

    async function loadFiles(grade){
      fileList().innerHTML = `<p class="muted">Loading ${grade} files…</p>`;
      try{
        const folderRef = ref(storage, `${grade}/`);
        const res = await listAll(folderRef);
        if(res.items.length===0){ fileList().innerHTML = `<p class="muted">No files yet in ${grade}.</p>`; return; }
        const grid = document.createElement('div'); grid.className='grid';
        for(const item of res.items){
          const url = await getDownloadURL(item);
          const a = document.createElement('a'); a.className='file'; a.href=url; a.target='_blank'; a.rel='noopener';
          a.textContent = item.name; grid.appendChild(a);
        }
        fileList().innerHTML=''; fileList().appendChild(grid);
      }catch(err){ fileList().innerHTML = `<p class="muted">Failed to load: ${err.message}</p>`; }
    }

    async function doUpload(){
      const file = document.getElementById('uploadInput').files[0];
      const grade = document.getElementById('uploadGrade').value;
      if(!file){ alert('Choose a file first.'); return; }
      const pathRef = ref(storage, `${grade}/${file.name}`);
      await uploadBytes(pathRef, file);
      alert('Uploaded!');
      loadFiles(grade);
    }

    onAuthStateChanged(auth, user => {
      if(!user){
        loginBox().classList.remove('hidden');
        content().classList.add('hidden');
        return;
      }
      const email = (user.email||'').toLowerCase();
      if(!email.endsWith('@'+ALLOWED_DOMAIN)){
        alert('Please use your school email (@'+ALLOWED_DOMAIN+').');
        signOut(auth); return;
      }
      welcome().textContent = `Welcome, ${email}`;
      loginBox().classList.add('hidden');
      content().classList.remove('hidden');
      admin().classList.toggle('hidden', email!==ADMIN_EMAIL);
    });

    // expose
    window.login = login; window.logout = logout; window.loadFiles = loadFiles; window.doUpload = doUpload;
  </script>
</head>
<body>
  <header>
    <h1>STEM Ms. Chang – Learning Resources</h1>
    <p class="muted">Grades 5–8 • Harmony Science Academy Lubbock • Sign in with your school email to access downloads</p>
  </header>

  <main>
    <!-- Login -->
    <div id="loginBox" class="card">
      <div class="row">
        <button onclick="login()">Sign in with Google</button>
        <span class="muted">Use your <strong>@harmonytx.org</strong> account</span>
      </div>
    </div>

    <!-- Content (after login) -->
    <div id="content" class="card hidden">
      <div class="row">
        <span id="welcome"></span>
        <button class="secondary" onclick="logout()">Sign out</button>
      </div>
      <div class="row" style="margin-top:10px">
        <strong>Select grade:</strong>
        <button onclick="loadFiles('5th')">5th</button>
        <button onclick="loadFiles('6th')">6th</button>
        <button onclick="loadFiles('7th')">7th</button>
        <button onclick="loadFiles('8th')">8th</button>
      </div>
      <div id="fileList" style="margin-top:12px"></div>

      <!-- Admin only: upload -->
      <div id="admin" class="hidden" style="margin-top:14px">
        <hr style="border-color:rgba(255,255,255,.15)">
        <div class="row">
          <strong>Upload (admin only)</strong>
          <select id="uploadGrade">
            <option value="5th">5th</option>
            <option value="6th">6th</option>
            <option value="7th">7th</option>
            <option value="8th">8th</option>
          </select>
          <input type="file" id="uploadInput" />
          <button onclick="doUpload()" style="background:var(--ok)">Upload</button>
        </div>
        <span class="tag">Admin: xchang@harmonytx.org</span>
      </div>
    </div>
  </main>

  <footer>
    <div class="muted">© 2025 STEM Ms. Chang • Harmony Science Academy Lubbock</div>
  </footer>
</body>
</html>
