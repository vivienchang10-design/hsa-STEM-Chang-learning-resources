<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STEM ‚Äì Ms Chang | Learning Resources</title>
  <!-- ÈÅøÂÖç 404 ÁöÑÂç†‰Ωç favicon -->
  <link rel="icon" href="data:," />
  <style>
    :root {
      --bg: #0f172a;      /* slate-900 */
      --panel: #111827;   /* gray-900 */
      --card: #1f2937;    /* gray-800 */
      --text: #e5e7eb;    /* gray-200 */
      --muted: #9ca3af;   /* gray-400 */
      --accent: #34d399;  /* emerald-400 */
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .topbar {
      display:flex; align-items:center; justify-content:space-between;
      padding: 16px 20px; background: var(--panel); border-bottom:1px solid #1f2937;
      position: sticky; top:0; z-index: 10;
    }
    .brand { display:flex; gap:12px; align-items:center; }
    .brand h1 { margin:0; font-size:18px; letter-spacing: .3px; }
    .subtitle { color: var(--muted); font-size:12px; line-height:1.1; }
    .btn {
      background: var(--accent); color:#041314; border:none; padding:8px 12px; border-radius:10px;
      font-weight:600; cursor:pointer;
    }
    .btn.secondary { background:#374151; color:#fff; }
    .layout { display:flex; min-height: calc(100vh - 64px); }
    .sidebar {
      width: 240px; border-right: 1px solid #1f2937; background: var(--panel); padding: 14px;
    }
    .grade-btn {
      width:100%; padding:10px 12px; margin-bottom:8px; border-radius:10px; background:#1f2937; color:#fff;
      text-align:left; border:1px solid #374151; cursor:pointer;
    }
    .grade-btn.active { outline:2px solid var(--accent); }
    .content { flex:1; padding: 18px; }
    .card {
      background: var(--card); border:1px solid #374151; border-radius:14px; padding:16px; margin-bottom:16px;
    }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    select, input[type="file"] {
      background:#0b1220; color:#fff; border:1px solid #374151; border-radius:10px; padding:8px 10px;
    }
    .files { margin:0; padding:0; list-style:none; }
    .files li {
      display:flex; justify-content:space-between; align-items:center;
      background:#0b1220; border:1px solid #1f2937; border-radius:10px; padding:10px 12px; margin:8px 0;
    }
    .muted { color: var(--muted); font-size:12px; }
    a.dl { color:#93c5fd; text-decoration:none; font-weight:600; }
    a.dl:hover { text-decoration:underline; }
    .hidden { display:none !important; }
    .footer {
      color: var(--muted); font-size:12px; text-align:center; padding:18px 10px;
    }
    .profile {
      font-size: 12px; color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div>
        <h1>STEM ‚Äì Ms Chang</h1>
        <div class="subtitle profile">
          Xiaqing (Vivien) Chang ¬∑ STEM Teacher K‚Äì8<br/>
          Harmony Science Academy, 3701 W Loop 289, Lubbock, TX 79407 ¬∑ 806-747-1000
        </div>
      </div>
    </div>
    <div id="userBox">
      <button id="loginBtn" class="btn">Sign in with Google</button>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <button class="grade-btn active" data-grade="5th">5th Grade</button>
      <button class="grade-btn" data-grade="6th">6th Grade</button>
      <button class="grade-btn" data-grade="7th">7th Grade</button>
      <button class="grade-btn" data-grade="8th">8th Grade</button>
      <div class="card" style="margin-top:12px;">
        <div class="muted">Sign in to access and download class materials.</div>
      </div>
    </aside>

    <main class="content">
      <div id="authGuard" class="card">
        <strong>Not signed in.</strong> Please click ‚ÄúSign in with Google‚Äù on the top right.
      </div>

      <section id="drive" class="hidden">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:700; font-size:18px; margin-bottom:6px;">
                <span id="pathTitle">5th / (root)</span>
              </div>
              <div class="muted">Only signed-in users can view and download files.</div>
            </div>
            <div class="muted" id="whoami"></div>
          </div>
        </div>

        <div class="card">
          <div class="row">
            <label for="folderSelect">Folder</label>
            <select id="folderSelect">
              <option value="">(root)</option>
            </select>
            <button id="addFolderBtn" class="btn secondary">+ New Folder</button>
          </div>
        </div>

        <div class="card">
          <div class="row">
            <input type="file" id="fileInput" multiple />
            <button id="uploadBtn" class="btn">Upload to current folder</button>
          </div>
          <div class="muted" style="margin-top:6px;">Tip: You can upload .pdf / .docx / .pptx etc.</div>
        </div>

        <div class="card">
          <ul id="fileList" class="files"></ul>
          <div id="emptyHint" class="muted hidden">No files yet in this folder.</div>
        </div>
      </section>

      <div class="footer">¬© STEM ‚Äì Ms Chang ‚Ä¢ Learning Resources</div>
    </main>
  </div>

  <!-- Firebase (modular v10) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getStorage, ref, listAll, getDownloadURL, uploadBytes
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ==== üîß Firebase ÈÖçÁΩÆÔºàÂ∑≤ÊîπÂØπ storageBucketÔºâ====
    const firebaseConfig = {
      apiKey: "AIzaSyDELcdhJKPrSVOGROj-yKl5rSGeNst6Z7k",
      authDomain: "chang-stem-class--materials.firebaseapp.com",
      projectId: "chang-stem-class--materials",
      storageBucket: "chang-stem-class--materials.appspot.com", // ‚úÖ ÂøÖÈ°ªÊòØ appspot.com
      messagingSenderId: "1066269130031",
      appId: "1:1066269130031:web:62b518c60d0c724571f5da",
      // measurementId ÂèØÁïôÁ©∫Ôºå‰∏çÈúÄË¶Å analytics
    };

    // ==== üîå ÂàùÂßãÂåñ ====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const storage = getStorage(app);

    // ==== üß© ÁÆÄÂçï UI ÁªëÂÆö ====
    const authGuard = document.getElementById('authGuard');
    const drive = document.getElementById('drive');
    const loginBtn = document.getElementById('loginBtn');
    const userBox = document.getElementById('userBox');
    const whoami = document.getElementById('whoami');
    const gradeButtons = Array.from(document.querySelectorAll('.grade-btn'));
    const folderSelect = document.getElementById('folderSelect');
    const addFolderBtn = document.getElementById('addFolderBtn');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileList = document.getElementById('fileList');
    const emptyHint = document.getElementById('emptyHint');
    const pathTitle = document.getElementById('pathTitle');

    let currentGrade = "5th";

    // ÁôªÂΩï/ÁôªÂá∫ÊåâÈíÆ
    function renderAuthButtons(user) {
      if (user) {
        userBox.innerHTML = `
          <div style="display:flex; align-items:center; gap:10px;">
            <span class="muted" title="${user.email}">Signed in: ${user.email}</span>
            <button id="logout" class="btn secondary">Sign out</button>
          </div>`;
        document.getElementById('logout').onclick = () => signOut(auth);
      } else {
        userBox.innerHTML = `<button id="loginBtn" class="btn">Sign in with Google</button>`;
        document.getElementById('loginBtn').onclick = async () => {
          try {
            await signInWithPopup(auth, provider);
          } catch (e) {
            console.error(e);
            alert(e.message || e.code || e);
          }
        };
      }
    }

    // Âπ¥Á∫ßÂàáÊç¢
    gradeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        gradeButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentGrade = btn.dataset.grade;
        loadFoldersAndFiles();
      });
    });

    folderSelect.addEventListener('change', () => {
      loadFiles();
    });

    addFolderBtn.addEventListener('click', async () => {
      const name = prompt("New folder name (no slashes):")?.trim();
      if (!name) return;
      if (name.includes('/')) {
        alert("Folder name cannot contain '/'.");
        return;
      }
      try {
        // ÈÄöËøáÂàõÂª∫‰∏Ä‰∏™Âç†‰ΩçÂØπË±°ÂÆûÁé∞‚ÄúÊñ∞Âª∫Êñá‰ª∂Â§π‚Äù
        const keepRef = ref(storage, `${currentGrade}/${name}/.keep`);
        await uploadBytes(keepRef, new Uint8Array(), { contentType: "text/plain" });
        await loadFoldersAndFiles();
        alert(`Folder "${name}" created.`);
      } catch (e) {
        console.error(e);
        alert(e.message || e.code || e);
      }
    });

    uploadBtn.addEventListener('click', async () => {
      const files = fileInput.files;
      if (!files || !files.length) {
        alert("Please choose file(s) to upload.");
        return;
      }
      const sub = folderSelect.value; // "" means root
      try {
        for (const f of files) {
          const path = sub ? `${currentGrade}/${sub}/${f.name}` : `${currentGrade}/${f.name}`;
          const fileRef = ref(storage, path);
          await uploadBytes(fileRef, f);
        }
        fileInput.value = "";
        await loadFiles();
        alert("Upload complete.");
      } catch (e) {
        console.error(e);
        alert(e.message || e.code || e);
      }
    });

    // Âä†ËΩΩ‚ÄúÂ≠êÊñá‰ª∂Â§π + Êñá‰ª∂‚Äù
    async function loadFoldersAndFiles() {
      pathTitle.textContent = `${currentGrade} / ${folderSelect.value || "(root)"}`;
      folderSelect.innerHTML = `<option value="">(root)</option>`;
      await loadFolders();  // Âä†ËΩΩÂ≠êÊñá‰ª∂Â§π
      await loadFiles();    // Âä†ËΩΩÂΩìÂâçÊñá‰ª∂
    }

    async function loadFolders() {
      try {
        const baseRef = ref(storage, `${currentGrade}/`);
        const { prefixes } = await listAll(baseRef);
        prefixes.sort((a, b) => a.name.localeCompare(b.name));
        for (const p of prefixes) {
          const name = p.name; // Â≠êÊñá‰ª∂Â§πÂêç
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          folderSelect.appendChild(opt);
        }
      } catch (e) {
        console.error(e);
        alert("Failed to list folders: " + (e.message || e.code || e));
      }
    }

    async function loadFiles() {
      fileList.innerHTML = "";
      emptyHint.classList.add('hidden');
      pathTitle.textContent = `${currentGrade} / ${folderSelect.value || "(root)"}`;

      try {
        const sub = folderSelect.value;
        const folderPath = sub ? `${currentGrade}/${sub}/` : `${currentGrade}/`;
        const folderRef = ref(storage, folderPath);
        const { items } = await listAll(folderRef);

        // ËøáÊª§Êéâ .keep
        const realItems = items.filter(it => !it.name.endsWith('/.keep') && it.name !== '.keep');

        if (!realItems.length) {
          emptyHint.classList.remove('hidden');
          return;
        }

        // ÁîüÊàê‰∏ãËΩΩÈìæÊé•
        for (const it of realItems) {
          const url = await getDownloadURL(it);
          const li = document.createElement('li');
          const niceName = it.name;
          li.innerHTML = `
            <span>${niceName}</span>
            <a class="dl" href="${url}" target="_blank" rel="noopener">Download</a>
          `;
          fileList.appendChild(li);
        }
      } catch (e) {
        console.error(e);
        alert("Failed to list files: " + (e.message || e.code || e));
      }
    }

    // ÁõëÂê¨ÁôªÂΩïÁä∂ÊÄÅ
    onAuthStateChanged(auth, (user) => {
      renderAuthButtons(user);
      if (user) {
        whoami.textContent = `Signed in as ${user.email}`;
        authGuard.classList.add('hidden');
        drive.classList.remove('hidden');
        loadFoldersAndFiles();
      } else {
        whoami.textContent = "";
        drive.classList.add('hidden');
        authGuard.classList.remove('hidden');
      }
    });

    // ÂàùÂßãÊ∏≤ÊüìÊåâÈíÆ
    renderAuthButtons(null);
  </script>
</body>
</html>
