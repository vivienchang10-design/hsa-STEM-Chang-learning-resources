<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STEM Ms. Chang ‚Äì Learning Resources</title>
  <!-- ÈÅøÂÖç /favicon.ico 404 -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Ctext y='24' font-size='24'%3Eüî¨%3C/text%3E%3C/svg%3E">
  <style>
    body{font-family:system-ui,Arial,Helvetica,sans-serif;margin:0;background:#f7f7fb;color:#222}
    header{background:#1f2937;color:#fff;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title{font-weight:700}
    .sub{opacity:.9;font-size:14px}
    .btn{padding:8px 12px;border:0;border-radius:10px;cursor:pointer}
    .primary{background:#2563eb;color:#fff}
    .ghost{background:#fff;color:#111;border:1px solid #e5e7eb}
    main{max-width:960px;margin:24px auto;padding:0 16px}
    .hidden{display:none}
    .grades{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;margin-bottom:12px}
    .muted{color:#6b7280}
    a{color:#2563eb;text-decoration:none}
    a:hover{text-decoration:underline}
    .folder{font-weight:600}
    .file{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px dashed #eee}
    .file:last-child{border-bottom:0}
    .note{background:#fff8e1;border:1px solid #fde68a;border-radius:10px;padding:10px}
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">STEM Ms. Chang</div>
      <div class="sub">K‚Äì8 STEM ‚Ä¢ Harmony Science Academy ‚Ä¢ Lubbock, TX</div>
    </div>
    <div>
      <button id="loginBtn" class="btn primary">Sign in with Google</button>
      <button id="logoutBtn" class="btn ghost hidden">Sign out</button>
    </div>
  </header>

  <main>
    <div id="needAuth" class="card">
      <div class="note">Please sign in with Google to view and download class materials.</div>
      <div class="muted" style="margin-top:8px">Tip: make sure your site URL
        <code>hsa-stem-chang-learning-resources.vercel.app</code> is in Firebase ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains.
      </div>
    </div>

    <div id="authedArea" class="hidden">
      <div class="card">
        <div id="userInfo" class="muted">Signed in</div>
        <div class="grades">
          <button class="btn ghost" data-grade="5th">5th Grade</button>
          <button class="btn ghost" data-grade="6th">6th Grade</button>
          <button class="btn ghost" data-grade="7th">7th Grade</button>
          <button class="btn ghost" data-grade="8th">8th Grade</button>
        </div>
        <div id="status" class="muted"></div>
      </div>

      <div id="list" class="card">
        <div class="muted">Select a grade above to list files.</div>
      </div>
    </div>
  </main>

  <!-- Firebase v11 Ê®°ÂùóÂåñ SDKÔºàÂÆòÊñπ CDNÔºâ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getStorage, ref, listAll, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // ==== ‰Ω†ÁöÑ Firebase ÈÖçÁΩÆÔºà‰øùÊåÅ appspot.com ‰Ωú storageBucketÔºâ====
    const firebaseConfig = {
      apiKey: "AIzaSyDELcdhJKPrSVOGROj-yKl5rSGeNst6Z7k",
      authDomain: "chang-stem-class--materials.firebaseapp.com",
      projectId: "chang-stem-class--materials",
      storageBucket: "chang-stem-class--materials.appspot.com",
      messagingSenderId: "1066269130031",
      appId: "1:1066269130031:web:62b518c60d0c724571f5da",
      measurementId: "G-D4N8JERGV8"
    };

    // ==== ÂàùÂßãÂåñ ====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const storage = getStorage(app);

    // ==== ÂÖÉÁ¥† ====
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const needAuth = document.getElementById("needAuth");
    const authedArea = document.getElementById("authedArea");
    const userInfo = document.getElementById("userInfo");
    const listEl = document.getElementById("list");
    const statusEl = document.getElementById("status");

    // ÁôªÂΩï / ÁôªÂá∫
    loginBtn.onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error(err);
        alert("Sign-in failed: " + (err?.message || err));
      }
    };
    logoutBtn.onclick = async () => { await signOut(auth); };

    // Âè™Âú®ÁôªÂΩïÂêéÂàóÂá∫Êñá‰ª∂ÔºàÈÅøÂÖçÊú™ÊéàÊùÉÂºïËµ∑ÁöÑ‚ÄúÂÉè CORS‚ÄùÁöÑ 403Ôºâ
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        needAuth.classList.add("hidden");
        authedArea.classList.remove("hidden");
        userInfo.textContent = `Signed in as ${user.email}`;
      } else {
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        needAuth.classList.remove("hidden");
        authedArea.classList.add("hidden");
        listEl.innerHTML = "<div class='muted'>Select a grade after signing in.</div>";
      }
    });

    // ÁªëÂÆöÂπ¥Á∫ßÊåâÈíÆ
    document.querySelectorAll("[data-grade]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const grade = btn.getAttribute("data-grade");
        await renderGrade(grade);
      });
    });

    async function renderGrade(grade) {
      statusEl.textContent = "Loading‚Ä¶";
      listEl.innerHTML = "";
      try {
        const rootRef = ref(storage, `${grade}/`);
        // Âè™Âàó‚ÄúËøô‰∏ÄÂ±Ç‚ÄùÔºå‰∏çÈÄíÂΩíÔºåÁÆÄÂçïÂèØÈù†
        const res = await listAll(rootRef);

        const container = document.createElement("div");

        // Â≠êÊñá‰ª∂Â§π
        if (res.prefixes.length) {
          const h = document.createElement("div");
          h.className = "folder";
          h.textContent = "Folders";
          container.appendChild(h);
          res.prefixes.forEach(p => {
            const row = document.createElement("div");
            row.className = "file";
            row.innerHTML = `<span>üìÅ ${p.name}/</span>
              <a href="#" data-sub="${p.fullPath}">Open</a>`;
            container.appendChild(row);
          });
        }

        // ÂΩìÂâçÂ±ÇÊñá‰ª∂
        if (res.items.length) {
          const h2 = document.createElement("div");
          h2.className = "folder";
          h2.style.marginTop = "8px";
          h2.textContent = "Files";
          container.appendChild(h2);

          for (const itemRef of res.items) {
            const url = await getDownloadURL(itemRef);
            const row = document.createElement("div");
            row.className = "file";
            row.innerHTML = `<span>üìÑ ${itemRef.name}</span>
              <a href="${url}" download>Download</a>`;
            container.appendChild(row);
          }
        }

        if (!res.prefixes.length && !res.items.length) {
          container.innerHTML = `<div class="muted">No files yet in <strong>${grade}</strong>.</div>`;
        }

        listEl.appendChild(container);

        // ÁÇπÂáª‚ÄúOpen‚ÄùËøõÂÖ•Â≠êÊñá‰ª∂Â§πÔºàÂÜçÊ¨° listAllÔºâ
        listEl.querySelectorAll("[data-sub]").forEach(a => {
          a.addEventListener("click", async (e) => {
            e.preventDefault();
            const sub = a.getAttribute("data-sub");
            await renderFolder(sub);
          });
        });

        statusEl.textContent = "";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Failed to load. Check Firebase rules / App Check (should be Unenforced) and Authorized domains.";
      }
    }

    async function renderFolder(path) {
      statusEl.textContent = `Loading ${path}‚Ä¶`;
      listEl.innerHTML = "";
      try {
        const res = await listAll(ref(storage, path + "/"));
        const container = document.createElement("div");
        const h = document.createElement("div");
        h.className = "folder";
        h.textContent = path;
        container.appendChild(h);

        for (const itemRef of res.items) {
          const url = await getDownloadURL(itemRef);
          const row = document.createElement("div");
          row.className = "file";
          row.innerHTML = `<span>üìÑ ${itemRef.name}</span>
            <a href="${url}" download>Download</a>`;
          container.appendChild(row);
        }

        if (!res.items.length) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = "No files in this folder.";
          container.appendChild(empty);
        }

        listEl.appendChild(container);
        statusEl.textContent = "";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Failed to open folder.";
      }
    }
  </script>
</body>
</html>
