<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STEM Ms Chang ‚Äî Learning Resources</title>
  <!-- ÂÜÖËÅî‰∏Ä‰∏™Â∞èÂõæÊ†áÔºåÈÅøÂÖç /favicon.ico 404 -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='18' fill='%23007bff'/%3E%3Ctext x='50' y='58' font-size='52' text-anchor='middle' fill='white' font-family='Arial,Helvetica,sans-serif'%3ES%3C/text%3E%3C/svg%3E">
  <style>
    :root{
      --bg:#0b1020;--card:#121931;--card2:#10172a;--text:#e7eaf6;--muted:#9fb0d2;
      --accent:#3b82f6;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1e);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid #1e2746;background:rgba(18,25,49,.8);backdrop-filter:blur(6px);position:sticky;top:0;z-index:10}
    .brand{display:flex;gap:12px;align-items:center}
    .badge{background:#1a2240;border:1px solid #2a3764;padding:6px 10px;border-radius:12px;color:var(--muted);font-size:12px}
    .main{display:grid;grid-template-columns:260px 1fr;gap:18px;padding:18px;max-width:1200px;margin:0 auto}
    .side{background:var(--card);border:1px solid #1e2746;border-radius:14px;padding:14px}
    .content{background:var(--card);border:1px solid #1e2746;border-radius:14px;padding:16px;min-height:60vh}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .btn{cursor:pointer;background:var(--accent);color:white;border:none;border-radius:10px;padding:10px 14px;font-weight:600}
    .btn.secondary{background:#24314f}
    .btn.ghost{background:transparent;border:1px solid #2a3764}
    .grades{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
    .grade{padding:8px 12px;border-radius:10px;border:1px solid #2a3764;background:#0f1935;cursor:pointer}
    .grade.active{background:#1d2a52;border-color:#3b82f6}
    .items{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;margin-top:10px}
    .card{background:var(--card2);border:1px solid #1e2746;border-radius:12px;padding:12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .tag{font-size:12px;color:var(--muted);background:#0d142b;border:1px solid #1d2850;padding:4px 8px;border-radius:999px}
    .link{color:#cfe2ff;text-decoration:none}
    .link:hover{text-decoration:underline}
    .hidden{display:none !important}
    .admin{margin-top:14px;border-top:1px dashed #2a3764;padding-top:12px}
    input[type=\"text\"]{background:#0d142b;color:var(--text);border:1px solid #2a3764;border-radius:10px;padding:8px 10px;width:100%}
    input[type=\"file\"]{color:var(--muted)}
    .crumb{color:var(--muted);font-size:13px}
    .crumb b{color:#cbd9ff}
    .notice{margin:14px 0;padding:10px;border-radius:10px;background:#0f1b33;border:1px solid #25345e;color:#cfe2ff}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div>
        <h1>STEM Ms Chang ‚Äî Learning Resources</h1>
        <div class="muted">Harmony Science Academy, Lubbock ‚Äî STEM Teacher K‚Äì8</div>
      </div>
    </div>
    <div>
      <span id="who" class="badge">Signed out</span>
      <button id="loginBtn" class="btn">Sign in with Google</button>
      <button id="logoutBtn" class="btn ghost hidden">Sign out</button>
    </div>
  </header>

  <div class="main">
    <aside class="side">
      <div class="muted">Grades</div>
      <div id="grades" class="grades"></div>

      <div class="admin hidden" id="adminPanel">
        <div class="muted" style="margin-bottom:6px;">Admin tools</div>
        <div class="notice">You are signed in as <b id="adminEmail"></b>. You can upload and create folders.</div>

        <label class="muted">Create folder inside current path</label>
        <div style="display:flex; gap:8px; margin:6px 0 12px;">
          <input id="newFolderName" type="text" placeholder="e.g. Unit 1" />
          <button class="btn secondary" id="createFolderBtn">+ Folder</button>
        </div>

        <label class="muted">Upload file to current path</label>
        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
          <input type="file" id="fileInput" />
          <button class="btn secondary" id="uploadBtn">Upload</button>
        </div>
      </div>
    </aside>

    <section class="content">
      <div id="needLogin" class="notice">
        Please <b>sign in with Google</b> to view and download class materials.
      </div>

      <div id="app" class="hidden">
        <div class="crumb">Path: <b id="pathLabel">5th/</b></div>
        <div id="folders" class="items"></div>
        <div id="files" class="items"></div>
      </div>
    </section>
  </div>

  <script type="module">
    // ==== Firebase SDK (v10) ====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged,
      signOut, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getStorage, ref, listAll, getDownloadURL, uploadBytes, deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    // ==== Your Firebase config (‰øÆÊ≠£‰∫Ü storageBucket ‰∏∫ appspot.com) ====
    const firebaseConfig = {
      apiKey: "AIzaSyDELcdhJKPrSVOGROj-yKl5rSGeNst6Z7k",
      authDomain: "chang-stem-class--materials.firebaseapp.com",
      projectId: "chang-stem-class--materials",
      storageBucket: "chang-stem-class--materials.appspot.com",
      messagingSenderId: "1066269130031",
      appId: "1:1066269130031:web:62b518c60d0c724571f5da",
      measurementId: "G-D4N8JERGV8"
    };

    // ==== App init ====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const storage = getStorage(app);

    // ÊåÅ‰πÖÂåñÁôªÂΩï
    await setPersistence(auth, browserLocalPersistence);

    // ==== Simple state ====
    const ADMIN_EMAILS = new Set(["vivien.chang10@gmail.com"]);
    const GRADES = ["5th","6th","7th","8th"];
    let currentPath = "5th/"; // ÈªòËÆ§Ë∑ØÂæÑ
    let isAdmin = false;

    // ==== UI refs ====
    const whoEl = document.getElementById("who");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const gradesEl = document.getElementById("grades");
    const needLoginEl = document.getElementById("needLogin");
    const appEl = document.getElementById("app");
    const pathLabel = document.getElementById("pathLabel");
    const foldersEl = document.getElementById("folders");
    const filesEl = document.getElementById("files");
    const adminPanel = document.getElementById("adminPanel");
    const adminEmail = document.getElementById("adminEmail");
    const newFolderName = document.getElementById("newFolderName");
    const createFolderBtn = document.getElementById("createFolderBtn");
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");

    // ==== Helpers ====
    function el(tag, attrs={}, children=[]) {
      const e = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => {
        if (k === "class") e.className = v;
        else if (k === "onclick") e.addEventListener("click", v);
        else e.setAttribute(k, v);
      });
      children.forEach(c => e.append(c));
      return e;
    }
    function setActiveGrade(grade) {
      currentPath = grade.endsWith("/") ? grade : grade + "/";
      pathLabel.textContent = currentPath;
      [...gradesEl.children].forEach(ch => ch.classList.toggle("active", ch.dataset.g === grade));
      loadPath(currentPath);
    }
    function renderGrades() {
      gradesEl.innerHTML = "";
      GRADES.forEach(g => {
        const btn = el("button", { class: "grade" + (g==="5th"?" active":""), "data-g": g, onclick: () => setActiveGrade(g) }, [g]);
        gradesEl.append(btn);
      });
    }
    function renderFolderCard(name, click) {
      return el("div",{class:"card"},[
        el("div",{class:"row"},[
          el("div",{},[ "üìÅ ", el("b",{},[name]) ]),
          el("button",{class:"btn ghost",onclick:click},["Open"])
        ])
      ]);
    }
    function renderFileCard(name, open) {
      const ext = name.split(".").pop()?.toUpperCase() || "";
      return el("div",{class:"card"},[
        el("div",{class:"row"},[
          el("div",{},[ "üìÑ ", el("b",{},[name]) ]),
          el("span",{class:"tag"},[ext])
        ]),
        el("div",{style:"margin-top:8px"},[
          el("a",{href:"#",class:"link",onclick:(e)=>{e.preventDefault();open();}},["Open / Download"])
        ])
      ]);
    }

    async function loadPath(path) {
      foldersEl.innerHTML = "";
      filesEl.innerHTML = "";
      const dirRef = ref(storage, path);
      try {
        const { prefixes, items } = await listAll(dirRef);

        // Â≠êÊñá‰ª∂Â§π
        if (prefixes.length) {
          prefixes.forEach(p => {
            const folderName = p.name; // child name
            const card = renderFolderCard(folderName, () => {
              // ËøõÂÖ•Â≠êÁõÆÂΩï
              currentPath = path + folderName + "/";
              pathLabel.textContent = currentPath;
              loadPath(currentPath);
            });
            foldersEl.append(card);
          });
        }

        // Êñá‰ª∂
        if (items.length) {
          for (const it of items) {
            const name = it.name;
            // Ë∑≥ËøáÊàë‰ª¨Áî®‰∫éÂàõÂª∫Á©∫ÁõÆÂΩïÁöÑÂç†‰ΩçÊñá‰ª∂
            if (name === ".keep") continue;
            const card = renderFileCard(name, async () => {
              const url = await getDownloadURL(it);
              // Êñ∞Á™óÂè£ÊâìÂºÄ
              window.open(url, "_blank", "noopener,noreferrer");
            });
            filesEl.append(card);
          }
        }

        if (!prefixes.length && !items.length) {
          filesEl.append(el("div",{class:"muted"},["This folder is empty."]));
        }
      } catch (err) {
        console.error(err);
        filesEl.append(el("div",{class:"notice"},["Failed to load. Check rules and path."]));
      }
    }

    // ==== Auth ====
    loginBtn.onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error(e);
        alert("Sign-in failed. See console for details.");
      }
    };
    logoutBtn.onclick = async () => {
      await signOut(auth);
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        whoEl.textContent = "Signed out";
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        needLoginEl.classList.remove("hidden");
        appEl.classList.add("hidden");
        adminPanel.classList.add("hidden");
        return;
      }
      whoEl.textContent = "Signed in as " + (user.email || user.uid);
      loginBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      needLoginEl.classList.add("hidden");
      appEl.classList.remove("hidden");

      isAdmin = ADMIN_EMAILS.has(user.email || "");
      adminPanel.classList.toggle("hidden", !isAdmin);
      if (isAdmin) adminEmail.textContent = user.email || "";

      // ÂàùÊ¨°Âä†ËΩΩ
      renderGrades();
      setActiveGrade(currentPath.replace("/","")); // ‰øùÊåÅÂú® 5th
    });

    // ==== Admin actions ====
    createFolderBtn.onclick = async () => {
      if (!isAdmin) return;
      const name = (newFolderName.value || "").trim().replace(/\\/+$/,"");
      if (!name) { alert("Folder name required"); return; }
      // ÈÄöËøá‰∏ä‰º†‰∏Ä‰∏™Âç†‰Ωç .keep Êñá‰ª∂Êù•‚ÄúÂàõÂª∫ÁõÆÂΩï‚Äù
      const keepRef = ref(storage, currentPath + name + "/.keep");
      const blob = new Blob(["keep"], { type: "text/plain" });
      try {
        await uploadBytes(keepRef, blob, { contentType: "text/plain" });
        newFolderName.value = "";
        await loadPath(currentPath);
        alert("Folder created.");
      } catch (e) {
        console.error(e);
        alert("Failed to create folder.");
      }
    };

    uploadBtn.onclick = async () => {
      if (!isAdmin) return;
      const f = fileInput.files?.[0];
      if (!f) { alert("Choose a file first."); return; }
      const fileRef = ref(storage, currentPath + f.name);
      try {
        await uploadBytes(fileRef, f, { contentType: f.type || "application/octet-stream" });
        fileInput.value = "";
        await loadPath(currentPath);
        alert("Uploaded.");
      } catch (e) {
        console.error(e);
        alert("Upload failed. Check Storage rules & login email.");
      }
    };

    // È°µÈù¢ÂàùÂßãÔºöÊ∏≤ÊüìÂπ¥Á∫ßÊ†áÁ≠æÔºå‰ΩÜ‰∏çÊòæÁ§∫ÂÜÖÂÆπÔºåÁ≠âÂæÖÁôªÂΩï
    renderGrades();
  </script>
</body>
</html>
