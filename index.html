<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STEM Ms. Chang ‚Äî Learning Resources</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 6px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .btn { padding: 6px 10px; border: 1px solid #ccc; background:#f7f7f7; cursor:pointer; border-radius:6px; }
    .btn:hover { background:#eee; }
    #gradeTabs { margin:14px 0; display:flex; gap:10px; }
    .tab { padding:6px 10px; border-radius:20px; border:1px solid #ddd; cursor:pointer; }
    .tab.active { background:#222; color:#fff; border-color:#222; }
    #adminBar { display:none; gap:8px; margin:12px 0; }
    .item { border:1px solid #eee; padding:10px; border-radius:10px; margin:10px 0; }
    .hint { color:#666; font-size:12px; margin-left:4px; }
    #msg { color:#b00; margin: 8px 0; min-height: 1em; }
  </style>
</head>
<body>
  <h1>STEM Ms. Chang ‚Äî Learning Resources</h1>
  <div>STEM Teacher K‚Äì8 ¬∑ Harmony Science Academy ¬∑ Lubbock, TX</div>

  <div class="row" style="margin:12px 0">
    <button id="loginBtn" class="btn">Sign in with Google</button>
    <button id="logoutBtn" class="btn" style="display:none">Sign out</button>
    <span id="who" class="hint"></span>
  </div>

  <div id="gradeTabs">
    <div class="tab active" data-grade="5th">5th Grade</div>
    <div class="tab" data-grade="6th">6th Grade</div>
    <div class="tab" data-grade="7th">7th Grade</div>
    <div class="tab" data-grade="8th">8th Grade</div>
  </div>

  <h2 id="gradeTitle">5th ‚Äî files &amp; folders</h2>
  <div id="adminBar" class="row">
    <input id="fileInput" type="file" />
    <button id="uploadBtn" class="btn">Upload to this grade</button>
    <button id="mkFolderBtn" class="btn">Ôºã New folder</button>
  </div>

  <div id="msg"></div>
  <div id="list"></div>

  <script type="module">
    // ==== Firebase SDK (v10) ====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getStorage, ref, listAll, uploadBytes, getDownloadURL, getMetadata, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ==== ‰Ω†ÁöÑÈ°πÁõÆÈÖçÁΩÆÔºàÊ≥®ÊÑè storageBucket Áî® firebasestorage.appÔºâ====
    const firebaseConfig = {
      apiKey: "AIzaSyDELcdhJKPrSVOGROj-yKl5rSGeNst6Z7k",
      authDomain: "chang-stem-class--materials.firebaseapp.com",
      projectId: "chang-stem-class--materials",
      storageBucket: "chang-stem-class--materials.firebasestorage.app", // ‚úÖ Ê≠£Á°Æ
      messagingSenderId: "1066269130031",
      appId: "1:1066269130031:web:62b518c60d0c724571f5da"
    };

    const app = initializeApp(firebaseConfig);
    // Âº∫Âà∂‰ΩøÁî®Ê≠£Á°ÆÁöÑ GS URLÔºàÂíå‰∏äÈù¢ÁöÑ storageBucket ‰∏ÄËá¥Ôºâ
    const storage = getStorage(app, "gs://chang-stem-class--materials.firebasestorage.app");
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ÁÆ°ÁêÜÂëòÈÇÆÁÆ±
    const ADMIN_EMAILS = ["vivien.chang10@gmail.com"];

    // UI refs
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const who = document.getElementById("who");
    const gradeTabs = document.getElementById("gradeTabs");
    const listEl = document.getElementById("list");
    const msgEl = document.getElementById("msg");
    const adminBar = document.getElementById("adminBar");
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const mkFolderBtn = document.getElementById("mkFolderBtn");
    const gradeTitle = document.getElementById("gradeTitle");

    let currentUser = null;
    let currentGrade = "5th";

    function setMessage(t=""){ msgEl.textContent = t; }
    function formatBytes(n){
      if (!Number.isFinite(n)) return "";
      const u=['B','KB','MB','GB','TB']; let i=0;
      while(n>=1024 && i<u.length-1){ n/=1024; i++; }
      return `${n.toFixed(n>=100?0:n>=10?1:2)} ${u[i]}`;
    }

    onAuthStateChanged(auth, (user) => {
      currentUser = user || null;
      if (user) {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        who.textContent = `Signed in: ${user.email}`;
        adminBar.style.display = ADMIN_EMAILS.includes(user.email) ? "flex" : "none";
        selectGrade(currentGrade);
      } else {
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        who.textContent = "";
        adminBar.style.display = "none";
        listEl.innerHTML = "";
        setMessage("Please sign in.");
      }
    });

    loginBtn.onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error(e);
        alert("Sign-in failed: " + (e?.message || e));
      }
    };
    logoutBtn.onclick = () => signOut(auth);

    gradeTabs.addEventListener("click", (e) => {
      const t = e.target.closest(".tab"); if (!t) return;
      for (const el of gradeTabs.querySelectorAll(".tab")) el.classList.toggle("active", el === t);
      currentGrade = t.dataset.grade;
      gradeTitle.textContent = `${currentGrade} ‚Äî files & folders`;
      if (currentUser) selectGrade(currentGrade);
    });

    async function selectGrade(grade){
      if (!currentUser) { setMessage("Please sign in first."); return; }
      setMessage("Loading...");
      listEl.innerHTML = "";
      try {
        const baseRef = ref(storage, `${grade}/`);
        const result = await listAll(baseRef);

        // Â≠êÊñá‰ª∂Â§π
        for (const p of result.prefixes) {
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `<b>üìÅ ${p.name}/</b><span class="hint">Folder</span>`;
          listEl.appendChild(div);

          const sub = await listAll(p);
          for (const f of sub.items) {
            await renderFileItem(`${grade}/${p.name}/${f.name}`, f);
          }
        }

        // Ê†πÁõÆÂΩïÊñá‰ª∂
        for (const f of result.items) {
          await renderFileItem(`${grade}/${f.name}`, f);
        }

        setMessage((!result.items.length && !result.prefixes.length) ? "No files yet. (Admins can upload.)" : "");
      } catch (err) {
        console.error(err);
        setMessage("Cannot list files. Check login, bucket, and Storage rules.");
      }
    }

    async function renderFileItem(path, fileRefObj){
      try {
        const url = await getDownloadURL(fileRefObj);
        const meta = await getMetadata(fileRefObj);
        const item = document.createElement("div");
        item.className = "item";
        const size = formatBytes(meta.size);
        const adminBtns = (currentUser && ADMIN_EMAILS.includes(currentUser.email))
          ? `<button class="btn" data-del="${path}">Delete</button>` : "";
        item.innerHTML = `
          <b>üìÑ ${path.split('/').pop()}</b>
          <div class="hint">Size: ${size || "‚Äî"}</div>
          <div class="row" style="margin-top:6px">
            <a class="btn" href="${url}" target="_blank" rel="noopener">Download</a>
            ${adminBtns}
          </div>
        `;
        listEl.appendChild(item);

        if (adminBtns) {
          item.querySelector('[data-del]').onclick = async () => {
            if (!confirm(\`Delete "${path}" ?\`)) return;
            try { await deleteObject(ref(storage, path)); item.remove(); }
            catch (e) { console.error(e); alert("Delete failed: " + (e?.message || e)); }
          };
        }
      } catch(e){
        console.error(e);
      }
    }

    // ‰∏ä‰º†
    uploadBtn.onclick = async () => {
      try {
        if (!currentUser) return alert("Please sign in first.");
        if (!ADMIN_EMAILS.includes(currentUser.email)) return alert("Only admin can upload.");
        const file = fileInput.files?.[0]; if (!file) return alert("Choose a file first.");
        const fileRef = ref(storage, `${currentGrade}/${file.name}`);
        await uploadBytes(fileRef, file);
        alert("Uploaded!");
        selectGrade(currentGrade);
      } catch(e){
        console.error(e);
        alert("Upload failed: " + (e?.message || e));
      }
    };

    // Êñ∞Âª∫‚ÄúÊñá‰ª∂Â§π‚Äù
    mkFolderBtn.onclick = async () => {
      try {
        if (!currentUser) return alert("Please sign in first.");
        if (!ADMIN_EMAILS.includes(currentUser.email)) return alert("Only admin can create folders.");
        const name = prompt("New folder name (letters/numbers only):"); if (!name) return;
        const safe = name.trim().replace(/[^a-z0-9-_ ]/gi, "_");
        const keepRef = ref(storage, `${currentGrade}/${safe}/.keep`);
        await uploadBytes(keepRef, new Blob([""], {type:"text/plain"}));
        alert(`Folder "${safe}" created.`);
        selectGrade(currentGrade);
      } catch(e){
        console.error(e);
        alert("Create folder failed: " + (e?.message || e));
      }
    };

    console.log("Host:", location.host);
    console.log("Using bucket:", firebaseConfig.storageBucket);
  </script>
</body>
</html>
