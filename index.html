<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getStorage, ref, listAll, uploadBytes, getDownloadURL,
    getMetadata, deleteObject
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // === ‰Ω†ÁöÑÈ°πÁõÆÈÖçÁΩÆÔºà‰øùÊåÅ‰Ω†Áé∞Âú®ÁöÑÔºåÊ°∂ÊòØ firebasestorage.appÔºâ ===
  const firebaseConfig = {
    apiKey: "AIzaSyDELcdhJKPrSVOGROj-yKl5rSGeNst6Z7k",
    authDomain: "chang-stem-class--materials.firebaseapp.com",
    projectId: "chang-stem-class--materials",
    storageBucket: "chang-stem-class--materials.firebasestorage.app",
    messagingSenderId: "1066269130031",
    appId: "1:1066269130031:web:62b518c60d0c724571f5da",
    measurementId: "G-D4N8JERGV8"
  };

  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app, "gs://chang-stem-class--materials.firebasestorage.app");
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // ÂèØÊ∑ªÂä†Â§ö‰∏™ÁÆ°ÁêÜÂëòÈÇÆÁÆ±
  const ADMIN_EMAILS = ["vivien.chang10@gmail.com"];

  // UI refs
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const who = document.getElementById("who");
  const gradeTabs = document.getElementById("gradeTabs");
  const listEl = document.getElementById("list");
  const msgEl = document.getElementById("msg");
  const adminBar = document.getElementById("adminBar");
  const fileInput = document.getElementById("fileInput");
  const uploadBtn = document.getElementById("uploadBtn");
  const mkFolderBtn = document.getElementById("mkFolderBtn");
  const gradeTitle = document.getElementById("gradeTitle");

  let currentUser = null;
  let currentGrade = null;

  function setMessage(text) { msgEl.textContent = text || ""; }
  function formatBytes(n){
    if (!Number.isFinite(n)) return "";
    const u = ['B','KB','MB','GB','TB']; let i = 0;
    while (n >= 1024 && i < u.length-1) { n /= 1024; i++; }
    return `${n.toFixed(n >= 100 ? 0 : n >= 10 ? 1 : 2)} ${u[i]}`;
  }

  onAuthStateChanged(auth, (user) => {
    currentUser = user || null;
    if (user) {
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      who.textContent = `Signed in: ${user.email}`;
      adminBar.style.display = ADMIN_EMAILS.includes(user.email) ? "flex" : "none";
      selectGrade("5th");
    } else {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      who.textContent = "";
      adminBar.style.display = "none";
      listEl.innerHTML = "";
      gradeTitle.textContent = "Please sign in, then select a grade.";
    }
  });

  loginBtn.onclick = async () => {
    try { await signInWithPopup(auth, provider); }
    catch (e) { console.error(e); alert("Sign-in failed: " + (e?.message || e)); }
  };
  logoutBtn.onclick = async () => { await signOut(auth); };

  gradeTabs.addEventListener("click", (e) => {
    const t = e.target.closest(".tab"); if (!t) return;
    const g = t.dataset.grade; selectGrade(g);
    for (const el of gradeTabs.querySelectorAll(".tab")) el.classList.toggle("active", el === t);
  });

  async function selectGrade(grade) {
    if (!currentUser) { setMessage("Please sign in first."); return; }
    currentGrade = grade;
    gradeTitle.textContent = `${grade} ‚Äî files & folders`;
    setMessage("Loading...");
    listEl.innerHTML = "";

    try {
      const baseRef = ref(storage, `${grade}/`);
      const result = await listAll(baseRef);

      // Â≠êÁõÆÂΩï
      for (const p of result.prefixes) {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<b>üìÅ ${p.name}/</b><span class="hint">Folder under ${grade}/</span>`;
        listEl.appendChild(div);

        const sub = await listAll(p);
        for (const f of sub.items) {
          await renderFileItem(`${grade}/${p.name}/${f.name}`, f);
        }
      }

      // Ê†πÁõÆÂΩïÊñá‰ª∂
      for (const f of result.items) {
        await renderFileItem(`${grade}/${f.name}`, f);
      }

      if (!result.items.length && !result.prefixes.length) setMessage("No files yet. (Admins can upload.)");
      else setMessage("");
    } catch (err) {
      console.error(err);
      setMessage("Cannot list files. Make sure you are signed in and Storage rules allow authenticated read.");
    }
  }

  async function renderFileItem(path, fileRefObj) {
    try {
      const url = await getDownloadURL(fileRefObj);
      const meta = await getMetadata(fileRefObj);
      const item = document.createElement("div");
      item.className = "item";
      const size = formatBytes(meta.size);
      const adminBtns = (currentUser && ADMIN_EMAILS.includes(currentUser.email))
        ? `<button class="btn" data-del="${path}">Delete</button>`
        : "";
      item.innerHTML = `
        <b>üìÑ ${path.split('/').slice(-1)[0]}</b>
        <div class="hint">Size: ${size || "‚Äî"}</div>
        <div class="row" style="margin-top:6px">
          <a class="btn" href="${url}" target="_blank" rel="noopener">Download</a>
          ${adminBtns}
        </div>
      `;
      listEl.appendChild(item);

      if (adminBtns) {
        item.querySelector('[data-del]').onclick = async () => {
          if (!confirm(`Delete "${path}" ?`)) return;
          try {
            await deleteObject(ref(storage, path));
            item.remove();
          } catch (e) {
            console.error(e);
            alert("Delete failed: " + (e?.message || e));
          }
        };
      }
    } catch (e) {
      console.error(e);
    }
  }

  // ÁÆ°ÁêÜÂëò‰∏ä‰º†
  uploadBtn.onclick = async () => {
    try {
      if (!currentUser) return alert("Please sign in first.");
      if (!ADMIN_EMAILS.includes(currentUser.email)) return alert("Only admin can upload.");
      if (!currentGrade) return alert("Select a grade first.");
      const file = fileInput.files?.[0]; if (!file) return alert("Choose a file first.");

      const fileRef = ref(storage, `${currentGrade}/${file.name}`);
      await uploadBytes(fileRef, file);
      alert("Uploaded!");
      selectGrade(currentGrade);
    } catch (e) {
      console.error(e);
      alert("Upload failed: " + (e?.message || e));
    }
  };

  // ÁÆ°ÁêÜÂëòÊñ∞Âª∫‚ÄúÊñá‰ª∂Â§π‚Äù
  mkFolderBtn.onclick = async () => {
    try {
      if (!currentUser) return alert("Please sign in first.");
      if (!ADMIN_EMAILS.includes(currentUser.email)) return alert("Only admin can create folders.");
      if (!currentGrade) return alert("Select a grade first.");
      const name = prompt("New folder name (letters/numbers only):");
      if (!name) return;
      const safe = name.trim().replace(/[^a-z0-9-_ ]/gi, "_");
      const blob = new Blob([""], { type: "text/plain" });
      const keepRef = ref(storage, `${currentGrade}/${safe}/.keep`);
      await uploadBytes(keepRef, blob);
      alert(`Folder "${safe}" created.`);
      selectGrade(currentGrade);
    } catch (e) {
      console.error(e);
      alert("Create folder failed: " + (e?.message || e));
    }
  };

  console.log("Using bucket:", firebaseConfig.storageBucket);
</script>
