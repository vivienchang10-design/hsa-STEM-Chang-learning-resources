<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>STEM Ms. Chang – Learning Resources</title>
  <!-- Inline favicon to avoid /favicon.ico 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" rx="24" fill="%230f172a"/><circle cx="64" cy="64" r="44" fill="%2338bdf8"/><text x="64" y="78" font-size="48" text-anchor="middle" fill="%23052538" font-family="Arial" font-weight="700">SC</text></svg>' />
  <!-- Help popup auth on Vercel; console warning is harmless -->
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups" />

  <style>
    :root{--bg:#0f172a;--card:#111827;--fg:#e5e7eb;--muted:#9ca3af;--accent:#38bdf8;--ok:#34d399;--warn:#fbbf24;--err:#f87171}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header,main,footer{max-width:960px;margin:0 auto;padding:20px}
    h1{margin:16px 0 6px;font-size:clamp(24px,5vw,40px)}
    .card{background:rgba(17,24,39,.85);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button,select,input[type=file]{background:var(--accent);color:#05253a;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;color:var(--fg);border:1px solid rgba(255,255,255,.18)}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .hidden{display:none}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:10px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    a.file{display:flex;gap:10px;align-items:center;padding:12px;border-radius:12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08)}
    a.file:hover{border-color:rgba(56,189,248,.6)}
    .tag{display:inline-block;margin-top:10px;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted)}
    .alert{margin-top:10px;padding:10px 12px;border-radius:10px;border:1px solid transparent}
    .alert.warn{background:#513c0022;border-color:#fbbf2422}
    .alert.err{background:#7f1d1d33;border-color:#fecaca33}
    code{background:rgba(255,255,255,.08);border-radius:6px;padding:1px 6px}
  </style>

  <!-- Firebase SDKs (v9 modular, stable) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { getStorage, ref, listAll, getDownloadURL, uploadBytes } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js';

    // === Firebase config (make sure storageBucket ends in appspot.com) ===
    const firebaseConfig = {
      apiKey: "AIzaSyDELcdhJKPrSVOGROj-yKl5rSGeNst6Z7k",
      authDomain: "chang-stem-class--materials.firebaseapp.com",
      projectId: "chang-stem-class--materials",
      storageBucket: "chang-stem-class--materials.appspot.com",
      messagingSenderId: "1066269130031",
      appId: "1:1066269130031:web:62b518c60d0c724571f5da",
      measurementId: "G-D4N8JERGV8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // Admin email (only this account can upload/delete)
    const ADMIN_EMAIL = 'vivien.chang10@gmail.com';

    const $ = (id) => document.getElementById(id);
    const show = (el, on=true) => el.classList.toggle('hidden', !on);

    const gradeBtns = [ 'btn5','btn6','btn7','btn8' ].map(id=>$(id));
    function setGradeButtonsDisabled(disabled){
      gradeBtns.forEach(b=> b.disabled = !!disabled);
    }

    // Disable grade buttons until signed in
    setGradeButtonsDisabled(true);

    // Google popup auth
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });

    async function login(){
      $('error').textContent = '';
      show($('errorWrap'), false);
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        show($('errorWrap'), true);
        $('error').textContent = `${e.code || 'auth/error'}: ${e.message}`;
      }
    }

    async function logout(){ await signOut(auth); }

    async function loadFiles(grade){
      $('fileList').innerHTML = `<p class="muted">Loading ${grade} files…</p>`;
      try{
        const folderRef = ref(storage, `${grade}/`);
        const res = await listAll(folderRef);
        if(res.items.length===0){
          $('fileList').innerHTML = `<div class="alert warn">No files yet in <b>${grade}</b>.<br>Upload as admin or try another grade.</div>`;
          return;
        }
        const grid = document.createElement('div'); grid.className='grid';
        for(const item of res.items){
          const url = await getDownloadURL(item);
          const a = document.createElement('a'); a.className='file';
          a.href=url; a.target='_blank'; a.rel='noopener';
          a.textContent = item.name; grid.appendChild(a);
        }
        $('fileList').innerHTML=''; $('fileList').appendChild(grid);
      }catch(err){
        let msg = err && err.message ? err.message : String(err);
        // Most common pseudo-CORS cause is Storage Rules deny (403), show actionable help
        const hint = `If you see CORS/Preflight errors, fix Storage Rules:\n`+
          `Firebase → Build → Storage → Rules →\n`+
          `  allow read: if request.auth != null;\n`+
          `  allow write: if request.auth != null && request.auth.token.email == "${ADMIN_EMAIL}";`;
        $('fileList').innerHTML = `<div class="alert err"><b>Failed to load ${grade}:</b> ${msg}<br><br><small>${hint.replace(/\n/g,'<br>')}</small></div>`;
      }
    }

    async function doUpload(){
      const file = $('uploadInput').files[0];
      const grade = $('uploadGrade').value;
      if(!file){ alert('Choose a file first.'); return; }
      try{
        const pathRef = ref(storage, `${grade}/${file.name}`);
        await uploadBytes(pathRef, file);
        alert('Uploaded!');
        loadFiles(grade);
      }catch(err){
        show($('errorWrap'), true);
        $('error').textContent = `Upload failed: ${err && err.message ? err.message : err}`;
      }
    }

    onAuthStateChanged(auth, user => {
      if(!user){
        show($('loginBox'), true);
        show($('content'), false);
        setGradeButtonsDisabled(true);
        return;
      }
      const email = (user.email||'').toLowerCase();
      $('welcome').textContent = `Welcome, ${email}`;
      show($('loginBox'), false);
      show($('content'), true);
      setGradeButtonsDisabled(false);
      $('admin').classList.toggle('hidden', email!==ADMIN_EMAIL);
    });

    // Expose handlers
    window.login = login; window.logout = logout; window.loadFiles = loadFiles; window.doUpload = doUpload;
  </script>
</head>
<body>
  <header>
    <h1>STEM Ms. Chang – Learning Resources</h1>
    <p class="muted">Grades 5–8 • Sign in to access downloads • Admin uploads with Gmail</p>
  </header>

  <main>
    <!-- Sign in card -->
    <div id="loginBox" class="card">
      <div class="row">
        <button onclick="login()">Sign in with Google</button>
        <span class="muted">Sign in first, then choose a grade below.</span>
      </div>
      <div id="errorWrap" class="alert err hidden"><span id="error"></span></div>
      <div class="alert warn" style="margin-top:8px">
        If you see <code>auth/unauthorized-domain</code>, add your domain in<br>
        <b>Firebase → Authentication → Settings → Authorized domains</b><br>
        e.g. <code>hsa-stem-chang-learning-resources.vercel.app</code>
      </div>
    </div>

    <!-- Content after sign-in -->
    <div id="content" class="card hidden">
      <div class="row">
        <span id="welcome"></span>
        <button class="secondary" onclick="logout()">Sign out</button>
      </div>
      <div class="row" style="margin-top:10px">
        <strong>Select grade:</strong>
        <button id="btn5" onclick="loadFiles('5th')">5th</button>
        <button id="btn6" onclick="loadFiles('6th')">6th</button>
        <button id="btn7" onclick="loadFiles('7th')">7th</button>
        <button id="btn8" onclick="loadFiles('8th')">8th</button>
      </div>
      <div id="fileList" style="margin-top:12px"></div>

      <div id="admin" class="hidden" style="margin-top:14px">
        <hr style="border-color:rgba(255,255,255,.15)">
        <div class="row">
          <strong>Upload (admin only)</strong>
          <select id="uploadGrade">
            <option value="5th">5th</option>
            <option value="6th">6th</option>
            <option value="7th">7th</option>
            <option value="8th">8th</option>
          </select>
          <input type="file" id="uploadInput" />
          <button onclick="doUpload()" style="background:var(--ok)">Upload</button>
        </div>
        <span class="tag">Admin: vivien.chang10@gmail.com</span>
      </div>
    </div>
  </main>

  <footer>
    <div class="muted">© 2025 STEM Ms. Chang • Learning Resources</div>
  </footer>
</body>
</html>
