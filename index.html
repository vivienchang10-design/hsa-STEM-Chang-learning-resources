<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>STEM Ms Chang - Learning Resources</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- 避免 favicon 404 -->
  <link rel="icon" href="data:,">

  <style>
    :root {
      --bg: #0b132b;
      --card: #1c2541;
      --muted: #3a506b;
      --accent: #5bc0be;
      --text: #e6f1ff;
      --warn: #ffce73;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; background: rgba(255,255,255,0.04); border-bottom: 1px solid rgba(255,255,255,0.07);
      position: sticky; top: 0; backdrop-filter: blur(8px); z-index: 5;
    }
    .title { font-weight: 700; letter-spacing: .3px; }
    .sub { font-size: 12px; opacity: .9; line-height: 1.2; margin-top: 2px; }
    .actions { display: flex; align-items: center; gap: 8px; }
    button, .btn {
      background: var(--accent); color: #062c30; border: 0; padding: 8px 12px; border-radius: 10px; font-weight: 700;
      cursor: pointer;
    }
    button.secondary { background: var(--muted); color: #eaf6ff; }
    main { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    .notice {
      background: #12223f; border: 1px solid rgba(91,192,190,.35);
      color: #c7f5f4; padding: 12px 14px; border-radius: 12px; margin-bottom: 12px;
    }
    .tabs { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 8px; margin: 16px 0 12px; }
    .tab {
      background: var(--card); padding: 10px 12px; border-radius: 12px; text-align: center; cursor: pointer;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .tab.active { outline: 2px solid var(--accent); }
    .card {
      background: var(--card); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 14px;
    }
    .list { display: grid; gap: 8px; }
    .file {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      background: #131b33; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06);
    }
    .file a { color: #b5e5e4; text-decoration: none; font-weight: 600; }
    .muted { color: #9fb2c8; font-size: 13px; }
    .row { display: flex; align-items: center; gap: 10px; }
    .right { display: flex; gap: 8px; }
    .hidden { display: none !important; }
    .uploader { margin-top: 14px; border-top: 1px dashed rgba(255,255,255,0.12); padding-top: 14px; }
    .small { font-size: 12px; color: #c9d7ff; }
    .error {
      background: #3b1a1a; color: #ffdada; border: 1px solid rgba(255, 128, 128, .35);
      padding: 10px 12px; border-radius: 12px; margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">STEM Ms Chang</div>
      <div class="sub">
        Xiaqing Chang — STEM Teacher K-8 · Harmony Science Academy, 3701 W Loop 289, Lubbock, TX 79407 · 806-747-1000
      </div>
    </div>
    <div class="actions">
      <span id="userEmail" class="muted"></span>
      <button id="loginBtn">Sign in</button>
      <button id="logoutBtn" class="secondary hidden">Sign out</button>
    </div>
  </header>

  <main>
    <div id="errorBox" class="error hidden"></div>
    <div id="infoBox" class="notice hidden"></div>

    <div class="tabs" id="tabs"></div>

    <div class="card">
      <div class="row">
        <div class="muted">Folder:</div>
        <div id="folderName" class="muted">—</div>
      </div>

      <div id="list" class="list" style="margin-top: 10px;"></div>

      <div id="uploader" class="uploader hidden">
        <div class="row" style="justify-content: space-between;">
          <div>
            <div style="font-weight:700;margin-bottom:6px;">Upload (admins only)</div>
            <div class="small">File will be saved to the current folder.</div>
          </div>
          <div class="right">
            <input type="file" id="fileInput" />
            <button id="uploadBtn" class="secondary">Upload</button>
          </div>
        </div>
        <div id="progress" class="small muted"></div>
      </div>
    </div>
  </main>

  <!-- Firebase v10 ESM -->
  <script type="module">
    // ====== 0) Config ======
    const firebaseConfig = {
      apiKey: "AIzaSyDELcdhJKPrSVOGROj-yKl5rSGeNst6Z7k",
      authDomain: "chang-stem-class--materials.firebaseapp.com",
      projectId: "chang-stem-class--materials",
      storageBucket: "chang-stem-class--materials.appspot.com",
      appId: "1:1066269130031:web:62b518c60d0c724571f5da"
    };

    const GRADES = ["5th", "6th", "7th", "8th"];
    const ADMIN_EMAILS = ["vivien.chang10@gmail.com"]; // 可加: "xchang@harmonytx.org"

    // ====== 1) Imports ======
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup,
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getStorage, ref, listAll, getDownloadURL, uploadBytesResumable
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    // ====== 2) Init ======
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // ====== 3) UI refs ======
    const tabs = document.getElementById("tabs");
    const listEl = document.getElementById("list");
    const folderNameEl = document.getElementById("folderName");
    const userEmailEl = document.getElementById("userEmail");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const uploader = document.getElementById("uploader");
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const progressEl = document.getElementById("progress");
    const infoBox = document.getElementById("infoBox");
    const errorBox = document.getElementById("errorBox");

    let currentGrade = GRADES[0];
    let currentUser = null;

    // ====== 4) Helpers ======
    function setError(msg) {
      if (!msg) {
        errorBox.classList.add("hidden");
        errorBox.textContent = "";
        return;
      }
      errorBox.textContent = msg;
      errorBox.classList.remove("hidden");
    }

    function setInfo(msg) {
      if (!msg) {
        infoBox.classList.add("hidden");
        infoBox.textContent = "";
        return;
      }
      infoBox.textContent = msg;
      infoBox.classList.remove("hidden");
    }

    function bytesToSize(bytes) {
      if (!bytes && bytes !== 0) return "";
      const sizes = ["B","KB","MB","GB","TB"];
      const i = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), sizes.length - 1);
      return (bytes / Math.pow(1024, i)).toFixed(2) + " " + sizes[i];
    }

    function isAdmin(email) {
      return ADMIN_EMAILS.indexOf(String(email || "").toLowerCase()) !== -1;
    }

    function requireSignedIn() {
      if (!currentUser) {
        setInfo("Please sign in to view and download class materials.");
        listEl.innerHTML = "";
        uploader.classList.add("hidden");
        return false;
      }
      setInfo("");
      return true;
    }

    // ====== 5) Build tabs ======
    function buildTabs() {
      tabs.innerHTML = "";
      GRADES.forEach(g => {
        const b = document.createElement("div");
        b.className = "tab" + (g === currentGrade ? " active" : "");
        b.textContent = g;
        b.dataset.grade = g;
        b.onclick = function () {
          if (g === currentGrade) return;
          currentGrade = g;
          document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
          b.classList.add("active");
          loadFolder();
        };
        tabs.appendChild(b);
      });
    }

    // ====== 6) List folder ======
    async function loadFolder() {
      folderNameEl.textContent = currentGrade + "/";

      if (!requireSignedIn()) {
        listEl.innerHTML = "";
        return;
      }

      setError("");
      listEl.innerHTML = "<div class='muted'>Loading...</div>";

      try {
        const folderRef = ref(storage, currentGrade + "/");
        const res = await listAll(folderRef);

        if (res.items.length === 0) {
          listEl.innerHTML = "<div class='muted'>This folder is empty.</div>";
        } else {
          listEl.innerHTML = "";
          // 逐个生成下载链接
          for (const itemRef of res.items) {
            const url = await getDownloadURL(itemRef);
            const fileName = itemRef.name;

            const row = document.createElement("div");
            row.className = "file";

            const left = document.createElement("div");
            left.className = "row";
            const nameA = document.createElement("a");
            nameA.href = url;
            nameA.textContent = fileName;
            nameA.target = "_blank";
            nameA.rel = "noopener";
            left.appendChild(nameA);

            const right = document.createElement("div");
            right.className = "right";
            const viewA = document.createElement("a");
            viewA.href = url;
            viewA.textContent = "View";
            viewA.target = "_blank";
            viewA.rel = "noopener";

            const downA = document.createElement("a");
            downA.href = url;
            downA.textContent = "Download";
            downA.setAttribute("download", fileName);

            right.appendChild(viewA);
            right.appendChild(downA);

            row.appendChild(left);
            row.appendChild(right);

            listEl.appendChild(row);
          }
        }

        // 控制上传模块显隐
        if (currentUser && isAdmin(currentUser.email)) {
          uploader.classList.remove("hidden");
        } else {
          uploader.classList.add("hidden");
        }
      } catch (err) {
        console.error(err);
        setError("Failed to list files: " + (err && err.message ? err.message : String(err)));
        listEl.innerHTML = "";
      }
    }

    // ====== 7) Auth UI ======
    loginBtn.onclick = async function () {
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error(err);
        setError("Sign-in failed: " + (err && err.message ? err.message : String(err)));
      }
    };

    logoutBtn.onclick = async function () {
      try {
        await signOut(auth);
      } catch (err) {
        console.error(err);
        setError("Sign-out failed: " + (err && err.message ? err.message : String(err)));
      }
    };

    onAuthStateChanged(auth, function (user) {
      currentUser = user || null;
      if (currentUser) {
        userEmailEl.textContent = currentUser.email || "";
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
      } else {
        userEmailEl.textContent = "";
        logoutBtn.classList.add("hidden");
        loginBtn.classList.remove("hidden");
      }
      // 登录状态变化后刷新列表
      loadFolder();
    });

    // ====== 8) Upload (admins only) ======
    uploadBtn.onclick = async function () {
      if (!currentUser) {
        setError("Please sign in first.");
        return;
      }
      if (!isAdmin(currentUser.email)) {
        setError("Only admins can upload.");
        return;
      }
      const f = fileInput.files && fileInput.files[0];
      if (!f) {
        setError("Please choose a file.");
        return;
      }
      setError("");
      progressEl.textContent = "Uploading...";

      try {
        const path = currentGrade + "/" + f.name;
        const fileRef = ref(storage, path);
        const task = uploadBytesResumable(fileRef, f);
        task.on("state_changed", function (snap) {
          const pct = snap.totalBytes ? Math.round((snap.bytesTransferred / snap.totalBytes) * 100) : 0;
          progressEl.textContent = "Uploading... " + pct + "%";
        }, function (err) {
          console.error(err);
          setError("Upload failed: " + (err && err.message ? err.message : String(err)));
          progressEl.textContent = "";
        }, async function () {
          progressEl.textContent = "Upload complete.";
          fileInput.value = "";
          await loadFolder();
          setTimeout(function () { progressEl.textContent = ""; }, 1500);
        });
      } catch (err) {
        console.error(err);
        setError("Upload failed: " + (err && err.message ? err.message : String(err)));
        progressEl.textContent = "";
      }
    };

    // ====== 9) Init UI ======
    buildTabs();
    folderNameEl.textContent = currentGrade + "/";
    // 首次列表在 onAuthStateChanged 里触发；未登录时会提示先登录
  </script>
</body>
</html>
