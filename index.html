<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>STEM Ms. Chang ‚Äî Learning Resources</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Â∞èÂõæÊ†áÔºåÈÅøÂÖç /favicon.ico 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="%230a7cff"/><text x="32" y="40" font-size="28" text-anchor="middle" fill="white" font-family="Arial">S</text></svg>' />
  <!-- ÁÆÄÂçïÊ†∑ÂºèÔºàÂèØÂà†Ôºâ -->
  <style>
    :root { --blue:#0a7cff; --bg:#f7f9fc; --card:#fff; --text:#222; --muted:#667; }
    *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text)}
    header{background:var(--card);border-bottom:1px solid #e5eaf0}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{width:40px;height:40px;border-radius:12px;background:var(--blue);display:grid;place-items:center;color:#fff;font-weight:700}
    .title{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:14px;margin:0}
    .grid{display:grid;grid-template-columns:260px 1fr;gap:16px;margin-top:16px}
    .card{background:var(--card);border:1px solid #e5eaf0;border-radius:14px;padding:14px}
    .btn{background:var(--blue);color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.outline{background:#fff;color:var(--blue);border:1px solid var(--blue)}
    .chip{background:#eef5ff;color:#125dcc;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;display:inline-block}
    .muted{color:var(--muted);font-size:12px}
    .grades button{width:100%;text-align:left;background:#fff;border:1px solid #e5eaf0;border-radius:12px;padding:10px 12px;margin-bottom:8px;cursor:pointer}
    .grades button.active{border-color:var(--blue);box-shadow:0 0 0 2px rgba(10,124,255,.12)}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .split{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .list{list-style:none;margin:0;padding:0}
    .list li{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 0;border-bottom:1px dashed #eef2f7}
    .file{display:flex;align-items:center;gap:8px}
    .file .tag{font-size:12px;padding:2px 6px;border-radius:6px;background:#f2f4f8;color:#444}
    .folder{font-weight:700}
    .hide{display:none}
    .danger{color:#c0392b;cursor:pointer;font-size:12px}
    input[type="file"]{max-width:320px}
    .pill{background:#eaf7ee;color:#237a3a;border-radius:999px;padding:4px 8px;font-size:12px}
    footer{margin:24px 0;color:var(--muted);font-size:12px}
    .lock{background:#fff6f6;border:1px solid #ffdede;color:#b03a2e;padding:10px;border-radius:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap split">
      <div class="brand">
        <div class="logo">SC</div>
        <div>
          <h1 class="title">STEM Ms. Chang ‚Äî Learning Resources</h1>
          <p class="sub">STEM Teacher K-8 ¬∑ Harmony Science Academy ¬∑ 3701 W Loop 289 ¬∑ Lubbock, TX 79407 ¬∑ 806-747-1000</p>
        </div>
      </div>
      <div class="row">
        <span id="userEmail" class="muted">Not signed in</span>
        <button id="loginBtn" class="btn">Sign in with Google</button>
        <button id="logoutBtn" class="btn outline hide">Sign out</button>
      </div>
    </div>
  </header>

  <div class="wrap grid">
    <!-- Â∑¶‰æßÔºöÂπ¥Á∫ßÈÄâÊã© -->
    <aside class="card">
      <div class="split" style="margin-bottom:8px">
        <strong>Grades</strong>
        <span class="chip">Signed-in students can download</span>
      </div>
      <div id="grades" class="grades"></div>
    </aside>

    <!-- Âè≥‰æßÔºöÊñá‰ª∂/Êñá‰ª∂Â§π -->
    <main class="card">
      <div class="split" style="margin-bottom:8px">
        <div class="row">
          <strong id="currentGrade">Select a grade</strong>
          <span id="writeGuard" class="lock hide">Read-only for students</span>
          <span id="adminPill" class="pill hide">Admin</span>
        </div>
        <div class="row">
          <select id="folderSelect" disabled></select>
          <button id="newFolderBtn" class="btn outline" disabled title="Create a subfolder (admin only)">Ôºã New Folder</button>
          <input id="fileInput" type="file" multiple disabled />
          <button id="uploadBtn" class="btn" disabled>Upload</button>
        </div>
      </div>

      <ul id="list" class="list"></ul>
      <footer>Tip: Folders appear after you upload at least one file into them.</footer>
    </main>
  </div>

  <!-- Firebase SDKÔºàCDN Ê®°ÂùóÁâàÔºâ -->
  <script type="module">
    // ‚úÖ ‰ΩøÁî® CDN ÁâàÊú¨ÔºàÈÄÇÂêàÁ∫Ø HTML / Vercel ÈùôÊÄÅÊâòÁÆ°Ôºâ
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup,
      onAuthStateChanged, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getStorage, ref, listAll, getDownloadURL, uploadBytes, deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    // üîß ‰Ω†ÁöÑ Firebase ÈÖçÁΩÆÔºàÊ≥®ÊÑè storageBucket Êîπ‰∏∫ appspot.comÔºâ
    const firebaseConfig = {
      apiKey: "AIzaSyDELcdhJKPrSVOGROj-yKl5rSGeNst6Z7k",
      authDomain: "chang-stem-class--materials.firebaseapp.com",
      projectId: "chang-stem-class--materials",
      storageBucket: "chang-stem-class--materials.appspot.com",
      messagingSenderId: "1066269130031",
      appId: "1:1066269130031:web:62b518c60d0c724571f5da",
      measurementId: "G-D4N8JERGV8"
    };

    // üß© ÂàùÂßãÂåñ
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const storage = getStorage(app);

    // üîê ‰øùÊåÅÁôªÂΩïÁä∂ÊÄÅÔºàlocalÔºâ
    await setPersistence(auth, browserLocalPersistence);

    // ‚Äî‚Äî DOM ‚Äî‚Äî //
    const gradesEl = document.getElementById("grades");
    const userEmailEl = document.getElementById("userEmail");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const currentGradeEl = document.getElementById("currentGrade");
    const listEl = document.getElementById("list");
    const folderSelect = document.getElementById("folderSelect");
    const newFolderBtn = document.getElementById("newFolderBtn");
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const writeGuard = document.getElementById("writeGuard");
    const adminPill = document.getElementById("adminPill");

    const GRADES = ["5th","6th","7th","8th"];
    let currentGrade = null;
    let isAdmin = false;

    // Â∑¶‰æßÂπ¥Á∫ßÊåâÈíÆ
    function renderGrades() {
      gradesEl.innerHTML = "";
      GRADES.forEach(g => {
        const btn = document.createElement("button");
        btn.textContent = g;
        btn.onclick = () => selectGrade(g, btn);
        gradesEl.appendChild(btn);
      });
    }

    function setActiveButton(btn) {
      [...gradesEl.children].forEach(b => b.classList.remove("active"));
      if (btn) btn.classList.add("active");
    }

    // ÈÄâÊã©Âπ¥Á∫ßÂêéÔºöÂä†ËΩΩÂ≠êÊñá‰ª∂Â§π + È°∂Â±ÇÊñá‰ª∂
    async function selectGrade(grade, btn) {
      currentGrade = grade;
      currentGradeEl.textContent = `${grade} Grade`;
      setActiveButton(btn);
      folderSelect.disabled = false;
      uploadBtn.disabled = !isAdmin;
      fileInput.disabled = !isAdmin;
      newFolderBtn.disabled = !isAdmin;

      await loadFoldersAndFiles();
    }

    // ÂàóÂá∫Âπ¥Á∫ß‰∏ãÁöÑÊâÄÊúâ‚ÄúÂ≠êÊñá‰ª∂Â§π‚Äù(prefixes) + È°∂Â±ÇÊñá‰ª∂(items)
    async function loadFoldersAndFiles() {
      listEl.innerHTML = "";
      folderSelect.innerHTML = "";

      if (!currentGrade) return;

      try {
        // Ê≥®ÊÑèÔºöFirebase Storage Ê≤°ÊúâÁúüÊ≠£ÁöÑÁ©∫Êñá‰ª∂Â§πÔºåÂè™Êúâ‚ÄúÂâçÁºÄ‚ÄùÔºõ
        // Âè™ÊúâÂΩìËØ•‚ÄúÂâçÁºÄ‚Äù‰∏ãËá≥Â∞ëÊúâ‰∏Ä‰∏™Êñá‰ª∂Êó∂ÔºåËøô‰∏™ÂâçÁºÄÊâç‰ºöË¢´ÂàóÂá∫Êù•„ÄÇ
        const rootRef = ref(storage, `${currentGrade}/`);
        const res = await listAll(rootRef);

        // ‰∏ãÊãâÂàóÂá∫Â≠êÊñá‰ª∂Â§πÔºàÂâçÁºÄÔºâ
        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = "(root)";
        folderSelect.appendChild(defaultOpt);

        res.prefixes.forEach(p => {
          const name = p.name; // Áõ¥Êé•ÊòØÂ≠êÊñá‰ª∂Â§πÂêç
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name + "/";
          folderSelect.appendChild(opt);
        });

        // Â±ïÁ§∫ÂΩìÂâçÂ±ÇÁöÑÊñá‰ª∂ÔºàÂπ¥Á∫ßÊ†πÁõÆÂΩïÔºâ
        if (res.items.length === 0 && res.prefixes.length === 0) {
          const li = document.createElement("li");
          li.innerHTML = `<span class="muted">No files yet. Admin can upload with the buttons above.</span>`;
          listEl.appendChild(li);
        } else {
          // ÂÖàÂ±ïÁ§∫Êñá‰ª∂Â§πÔºàÁÇπÂáªÂä†ËΩΩËØ•Êñá‰ª∂Â§πÂÜÖÊñá‰ª∂Ôºâ
          res.prefixes.forEach(p => {
            const li = document.createElement("li");
            const left = document.createElement("div");
            left.className = "file folder";
            left.textContent = "üìÅ " + p.name + "/";
            li.appendChild(left);

            const openBtn = document.createElement("button");
            openBtn.className = "btn outline";
            openBtn.textContent = "Open";
            openBtn.onclick = () => loadOneFolder(p.name);
            li.appendChild(openBtn);
            listEl.appendChild(li);
          });

          // ÂÜçÂ±ïÁ§∫ÂΩìÂâçÂ±ÇÊñá‰ª∂
          for (const itemRef of res.items) {
            const url = await getDownloadURL(itemRef);
            const li = document.createElement("li");
            const left = document.createElement("div");
            left.className = "file";
            left.innerHTML = `üìÑ <a href="${url}" target="_blank" rel="noopener">${itemRef.name}</a>`;
            li.appendChild(left);

            if (isAdmin) {
              const del = document.createElement("span");
              del.className = "danger";
              del.textContent = "Delete";
              del.onclick = async () => {
                if (confirm(`Delete "${itemRef.name}"?`)) {
                  await deleteObject(itemRef);
                  await loadFoldersAndFiles();
                }
              };
              li.appendChild(del);
            }
            listEl.appendChild(li);
          }
        }
      } catch (e) {
        console.error(e);
        showError(e);
      }
    }

    // Âä†ËΩΩÊüê‰∏™Â≠êÊñá‰ª∂Â§πÂÜÖÂÆπ
    async function loadOneFolder(sub) {
      if (!currentGrade) return;
      listEl.innerHTML = "";
      try {
        const fRef = ref(storage, `${currentGrade}/${sub}/`);
        const res = await listAll(fRef);

        const backLi = document.createElement("li");
        const backBtn = document.createElement("button");
        backBtn.className = "btn outline";
        backBtn.textContent = "‚Üê Back to grade";
        backBtn.onclick = loadFoldersAndFiles;
        backLi.appendChild(backBtn);
        listEl.appendChild(backLi);

        if (res.items.length === 0 && res.prefixes.length === 0) {
          const li = document.createElement("li");
          li.innerHTML = `<span class="muted">Empty folder.</span>`;
          listEl.appendChild(li);
        }

        // ÊòæÁ§∫Ê≠§Êñá‰ª∂Â§π‰∏ãÁöÑÂ≠êÊñá‰ª∂Â§πÔºàÊõ¥Ê∑±‰∏ÄÂ±ÇÔºâ
        res.prefixes.forEach(p => {
          const li = document.createElement("li");
          const left = document.createElement("div");
          left.className = "file folder";
          left.textContent = "üìÅ " + p.name + "/";
          li.appendChild(left);

          const openBtn = document.createElement("button");
          openBtn.className = "btn outline";
          openBtn.textContent = "Open";
          openBtn.onclick = () => loadOneFolder(`${sub}/${p.name}`);
          li.appendChild(openBtn);
          listEl.appendChild(li);
        });

        for (const itemRef of res.items) {
          const url = await getDownloadURL(itemRef);
          const li = document.createElement("li");
          const left = document.createElement("div");
          left.className = "file";
          left.innerHTML = `üìÑ <a href="${url}" target="_blank" rel="noopener">${itemRef.name}</a>`;
          li.appendChild(left);

          if (isAdmin) {
            const del = document.createElement("span");
            del.className = "danger";
            del.textContent = "Delete";
            del.onclick = async () => {
              if (confirm(`Delete "${itemRef.name}"?`)) {
                await deleteObject(itemRef);
                await loadOneFolder(sub);
              }
            };
            li.appendChild(del);
          }
          listEl.appendChild(li);
        }
      } catch (e) {
        console.error(e);
        showError(e);
      }
    }

    // Êñ∞Âª∫Â≠êÊñá‰ª∂Â§πÔºàÈÄöËøáÂç†‰Ωç .keep Êñá‰ª∂ÂÆûÁé∞Ôºâ
    newFolderBtn.onclick = async () => {
      if (!isAdmin || !currentGrade) return;
      const name = prompt("Folder name (no leading/trailing /):");
      if (!name) return;
      const safe = name.replace(/^\/*|\/*$/g, ""); // ÂéªÊéâÈ¶ñÂ∞æ /
      const fileRef = ref(storage, `${currentGrade}/${safe}/.keep`);
      try {
        await uploadBytes(fileRef, new Blob([""], { type: "text/plain" }));
        await loadFoldersAndFiles();
        // Ëá™Âä®ÈÄâ‰∏≠ÂàöÂª∫ÁöÑÊñá‰ª∂Â§π
        [...folderSelect.options].forEach(o => { if (o.value === safe) folderSelect.value = safe; });
      } catch (e) {
        console.error(e);
        showError(e);
      }
    };

    // ‰∏ä‰º†
    uploadBtn.onclick = async () => {
      if (!isAdmin || !currentGrade) return;
      const files = fileInput.files;
      if (!files || files.length === 0) return alert("Choose files first.");
      uploadBtn.disabled = true;

      const sub = folderSelect.value; // "" Ë°®Á§∫Ê†πÁõÆÂΩï
      try {
        for (const f of files) {
          const path = sub ? `${currentGrade}/${sub}/${f.name}` : `${currentGrade}/${f.name}`;
          await uploadBytes(ref(storage, path), f);
        }
        fileInput.value = "";
        await (sub ? loadOneFolder(sub) : loadFoldersAndFiles());
      } catch (e) {
        console.error(e);
        showError(e);
      } finally {
        uploadBtn.disabled = false;
      }
    };

    // ÁôªÂΩï/ÈÄÄÂá∫
    loginBtn.onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error(e);
        showError(e);
      }
    };
    logoutBtn.onclick = async () => auth.signOut();

    // Ê†πÊçÆÁôªÂΩïÁä∂ÊÄÅÊõ¥Êñ∞ UI
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userEmailEl.textContent = user.email || "Signed in";
        loginBtn.classList.add("hide");
        logoutBtn.classList.remove("hide");

        isAdmin = (user.email === "vivien.chang10@gmail.com");
        writeGuard.classList.toggle("hide", isAdmin);
        adminPill.classList.toggle("hide", !isAdmin);

        // Ëá™Âä®ÈÄâÁ¨¨‰∏Ä‰∏™Âπ¥Á∫ß
        if (!currentGrade) {
          const firstBtn = gradesEl.querySelector("button");
          if (firstBtn) firstBtn.click();
        } else {
          // Âà∑Êñ∞ÂΩìÂâçËßÜÂõæ
          await loadFoldersAndFiles();
        }
      } else {
        userEmailEl.textContent = "Not signed in";
        loginBtn.classList.remove("hide");
        logoutBtn.classList.add("hide");
        isAdmin = false;
        writeGuard.classList.remove("hide");
        adminPill.classList.add("hide");
        // ‰ªçÂÖÅËÆ∏Êü•ÁúãÂ∑¶‰æßÂπ¥Á∫ßÔºå‰ΩÜÂè≥‰æß‰ºöÊèêÁ§∫Âè™ËØªÔºàÊ≤°Êúâ‰∏ä‰º†/Âà†Èô§Ôºâ
        uploadBtn.disabled = true;
        fileInput.disabled = true;
        newFolderBtn.disabled = true;
      }
    });

    function showError(e) {
      alert((e && e.message) ? e.message : "Something went wrong.");
    }

    // Ê∏≤ÊüìÂπ¥Á∫ßÂàóË°®
    renderGrades();
  </script>
</body>
</html>
