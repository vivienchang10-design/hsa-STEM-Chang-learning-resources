<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>STEM Ms. Chang – Learning Resources</title>

  <!-- Inline favicon (no 404 anymore) -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" rx="24" fill="%230f172a"/><circle cx="64" cy="64" r="44" fill="%2338bdf8"/><text x="64" y="78" font-size="48" text-anchor="middle" fill="%23052538" font-family="Arial" font-weight="700">SC</text></svg>' />

  <!-- COOP relaxed for auth flows (backup to Vercel headers below) -->
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups" />

  <style>
    :root{--bg:#0f172a;--card:#111827;--fg:#e5e7eb;--muted:#9ca3af;--accent:#38bdf8;--ok:#34d399}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--fg);
         font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header,main,footer{max-width:960px;margin:0 auto;padding:20px}
    h1{margin:16px 0 6px;font-size:clamp(24px,5vw,40px)}
    .card{background:rgba(17,24,39,.85);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button,select,input[type=file]{background:var(--accent);color:#05253a;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;color:var(--fg);border:1px solid rgba(255,255,255,.18)}
    .hidden{display:none}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:10px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    a.file{display:flex;gap:10px;align-items:center;padding:12px;border-radius:12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08)}
    a.file:hover{border-color:rgba(56,189,248,.6)}
    .tag{display:inline-block;margin-top:10px;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted)}
    .error{margin-top:10px;color:#fecaca;background:#7f1d1d33;padding:8px 12px;border-radius:10px;border:1px solid #fecaca33}
  </style>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import {
      getAuth, OAuthProvider, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import {
      getStorage, ref, listAll, getDownloadURL, uploadBytes
    } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js';

    // === Your Firebase config (storageBucket corrected to appspot.com) ===
    const firebaseConfig = {
      apiKey: "AIzaSyDELcdhJKPrSVOGROj-yKl5rSGeNst6Z7k",
      authDomain: "chang-stem-class--materials.firebaseapp.com",
      projectId: "chang-stem-class--materials",
      storageBucket: "chang-stem-class--materials.appspot.com",
      messagingSenderId: "1066269130031",
      appId: "1:1066269130031:web:62b518c60d0c724571f5da",
      measurementId: "G-D4N8JERGV8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);

    const ADMIN_EMAIL = 'xchang@harmonytx.org';
    const ALLOWED_DOMAIN = 'harmonytx.org';

    // --- UI helpers ---
    const $ = (id) => document.getElementById(id);
    const show = (el, on=true) => el.classList.toggle('hidden', !on);

    // Microsoft provider + redirect (avoids popup/COOP issues)
    const provider = new OAuthProvider('microsoft.com');
    provider.setCustomParameters({ prompt: 'select_account' });
    // 如需固定到单一租户，可取消注释并填 tenant ID：
    // provider.setCustomParameters({ tenant: 'YOUR_TENANT_ID' });

    async function login(){
      if (sessionStorage.getItem('authRedirecting')) return;
      sessionStorage.setItem('authRedirecting','1');
      try {
        await signInWithRedirect(auth, provider);
      } catch (e){
        show($('error'), true); $('error').textContent = e.message;
        sessionStorage.removeItem('authRedirecting');
      }
    }
    async function logout(){ await signOut(auth); }

    // Handle redirect result (and clear the guard)
    getRedirectResult(auth).catch(e => {
      // 错误展示（例如 unauthorized-domain 仍需在控制台加域名）
      if (e && e.code) {
        show($('error'), true);
        $('error').textContent = `Auth error: ${e.code}. ${e.message}`;
      }
    }).finally(() => { sessionStorage.removeItem('authRedirecting'); });

    async function loadFiles(grade){
      $('fileList').innerHTML = `<p class="muted">Loading ${grade} files…</p>`;
      try{
        const folderRef = ref(storage, `${grade}/`);
        const res = await listAll(folderRef);
        if(res.items.length===0){
          $('fileList').innerHTML = `<p class="muted">No files yet in ${grade}.</p>`;
          return;
        }
        const grid = document.createElement('div'); grid.className='grid';
        for(const item of res.items){
          const url = await getDownloadURL(item);
          const a = document.createElement('a'); a.className='file';
          a.href=url; a.target='_blank'; a.rel='noopener';
          a.textContent = item.name; grid.appendChild(a);
        }
        $('fileList').innerHTML=''; $('fileList').appendChild(grid);
      }catch(err){
        $('fileList').innerHTML = `<p class="error">Failed to load: ${err.message}</p>`;
      }
    }

    async function doUpload(){
      const file = $('uploadInput').files[0];
      const grade = $('uploadGrade').value;
      if(!file){ alert('Choose a file first.'); return; }
      const pathRef = ref(storage, `${grade}/${file.name}`);
      await uploadBytes(pathRef, file);
      alert('Uploaded!');
      loadFiles(grade);
    }

    onAuthStateChanged(auth, user => {
      if(!user){
        show($('loginBox'), true);
        show($('content'), false);
        return;
      }
      const email = (user.email||'').toLowerCase();
      if(!email.endsWith('@'+ALLOWED_DOMAIN)){
        alert('Please use your school email (@'+ALLOWED_DOMAIN+').');
        signOut(auth); return;
      }
      $('welcome').textContent = `Welcome, ${email}`;
      show($('loginBox'), false);
      show($('content'), true);
      $('admin').classList.toggle('hidden', email!==ADMIN_EMAIL);
    });

    // Expose
    window.login = login; window.logout = logout;
    window.loadFiles = loadFiles; window.doUpload = doUpload;
  </script>
</head>
<body>
  <header>
    <h1>STEM Ms. Chang – Learning Resources</h1>
    <p class="muted">Grades 5–8 • Harmony Science Academy Lubbock • Sign in with your school email to access downloads</p>
  </header>

  <main>
    <!-- Login -->
    <div id="loginBox" class="card">
      <div class="row">
        <button onclick="login()">Sign in with Microsoft</button>
        <span class="muted">Use your <strong>@harmonytx.org</strong> account</span>
      </div>
      <div id="error" class="error hidden"></div>
    </div>

    <!-- Content (after login) -->
    <div id="content" class="card hidden">
      <div class="row">
        <span id="welcome"></span>
        <button class="secondary" onclick="logout()">Sign out</button>
      </div>
      <div class="row" style="margin-top:10px">
        <strong>Select grade:</strong>
        <button onclick="loadFiles('5th')">5th</button>
        <button onclick="loadFiles('6th')">6th</button>
        <button onclick="loadFiles('7th')">7th</button>
        <button onclick="loadFiles('8th')">8th</button>
      </div>
      <div id="fileList" style="margin-top:12px"></div>

      <!-- Admin only: upload -->
      <div id="admin" class="hidden" style="margin-top:14px">
        <hr style="border-color:rgba(255,255,255,.15)">
        <div class="row">
          <strong>Upload (admin only)</strong>
          <select id="uploadGrade">
            <option value="5th">5th</option>
            <option value="6th">6th</option>
            <option value="7th">7th</option>
            <option value="8th">8th</option>
          </select>
          <input type="file" id="uploadInput" />
          <button onclick="doUpload()" style="background:var(--ok)">Upload</button>
        </div>
        <span class="tag">Admin: xchang@harmonytx.org</span>
      </div>
    </div>
  </main>

  <footer>
    <div class="muted">© 2025 STEM Ms. Chang • Harmony Science Academy Lubbock</div>
  </footer>
</body>
</html>
