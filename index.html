<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>STEM Ms. Chang ‚Äî Learning Resources</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; }
    header { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid #eee; }
    .brand { font-weight:700; }
    .container { display:flex; min-height: calc(100vh - 56px); }
    aside { width:220px; border-right:1px solid #eee; padding:12px; }
    main { flex:1; padding:16px; }
    button { padding:8px 12px; border:1px solid #ddd; background:#fff; border-radius:8px; cursor:pointer; }
    button:hover { background:#f7f7f7; }
    .grade-btn { width:100%; text-align:left; margin-bottom:8px; }
    .row { display:flex; justify-content:space-between; align-items:center; gap:8px; margin:8px 0; }
    .muted { color:#666; }
    .pill { font-size:12px; padding:2px 8px; border-radius:12px; background:#f1f1f1; }
    ul { list-style:none; padding:0; margin:0; }
    li { padding:8px 0; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; gap:12px; align-items:center; }
    .hidden { display:none; }
    .error { color:#b00020; white-space:pre-wrap; }
    input[type="file"] { display:none; }
    .link { color:#0b57d0; text-decoration:none; }
    .link:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <header>
    <div class="brand">STEM Ms. Chang ‚Äî Learning Resources</div>
    <div>
      <span id="userEmail" class="muted"></span>
      <button id="loginBtn">Sign in with Google</button>
      <button id="logoutBtn" class="hidden">Sign out</button>
    </div>
  </header>

  <div class="container">
    <aside>
      <div class="row">
        <div class="muted">Grades</div>
        <button id="addFolderBtn" class="hidden" title="Admin only">+ New Folder</button>
      </div>
      <div id="gradeList"></div>
    </aside>

    <main>
      <h2 id="currentGradeTitle">Please sign in</h2>
      <div id="uploadBar" class="row hidden">
        <div class="pill">Admin upload</div>
        <label><button id="chooseFileBtn">Choose file</button><input id="fileInput" type="file" /></label>
        <button id="uploadBtn">Upload to current folder</button>
        <span id="uploadStatus" class="muted"></span>
      </div>

      <div id="needLogin" class="muted">Sign in to view and download materials.</div>
      <div id="loading" class="muted hidden">Loading...</div>
      <div id="error" class="error hidden"></div>

      <ul id="fileList"></ul>
    </main>
  </div>

  <script type="module">
    /************ Firebase (v10) ************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getStorage, ref, listAll, getDownloadURL, uploadBytes
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    // ‚úÖ ‰ΩøÁî®‰Ω†È°πÁõÆÁöÑÈÖçÁΩÆÔºõÊ≥®ÊÑè storageBucket ÂøÖÈ°ªÊòØ .appspot.com ÁªìÂ∞æ
    const firebaseConfig = {
      apiKey: "AIzaSyDELcdhJKPrSVOGROj-yKl5rSGeNst6Z7k",
      authDomain: "chang-stem-class--materials.firebaseapp.com",
      projectId: "chang-stem-class--materials",
      storageBucket: "chang-stem-class--materials.appspot.com",   // ‚Üê Â∑≤‰øÆÊ≠£
      messagingSenderId: "1066269130031",
      appId: "1:1066269130031:web:62b518c60d0c724571f5da"
      // measurementId ÂèØÁúÅÁï•
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Storage
    const storage = getStorage(app);

    /************ UI elements ************/
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userEmailEl = document.getElementById('userEmail');
    const currentGradeTitle = document.getElementById('currentGradeTitle');
    const gradeList = document.getElementById('gradeList');
    const fileList = document.getElementById('fileList');
    const needLogin = document.getElementById('needLogin');
    const loading = document.getElementById('loading');
    const errorBox = document.getElementById('error');

    const addFolderBtn = document.getElementById('addFolderBtn');
    const uploadBar = document.getElementById('uploadBar');
    const chooseFileBtn = document.getElementById('chooseFileBtn');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadStatus = document.getElementById('uploadStatus');

    // ‰Ω†ÁöÑÁÆ°ÁêÜÂëòÈÇÆÁÆ±ÔºàÂè™ÊúâÂÆÉËÉΩ‰∏ä‰º†/Êñ∞Âª∫Êñá‰ª∂Â§πÔºâ
    const ADMIN_EMAIL = "vivien.chang10@gmail.com";

    // ÈªòËÆ§Âπ¥Á∫ßÂàóË°®Ôºà‰Ω†‰πüÂèØ‰ª•ÈÄöËøá‚Äú+ New Folder‚ÄùÂàõÂª∫Êõ¥Â§öÔºâ
    let gradeFolders = ["5th", "6th", "7th", "8th"];
    let currentGrade = null;
    let chosenFile = null;

    function setError(msg) {
      errorBox.textContent = msg;
      errorBox.classList.remove('hidden');
    }
    function clearError() {
      errorBox.textContent = '';
      errorBox.classList.add('hidden');
    }

    function renderGrades() {
      gradeList.innerHTML = '';
      gradeFolders.forEach(g => {
        const btn = document.createElement('button');
        btn.className = 'grade-btn';
        btn.textContent = g;
        btn.onclick = () => {
          currentGrade = g;
          currentGradeTitle.textContent = g + " Grade";
          loadFilesForGrade(g);
        };
        gradeList.appendChild(btn);
      });
    }

    async function loadFilesForGrade(grade) {
      if (!auth.currentUser) {
        needLogin.classList.remove('hidden');
        return;
      }
      clearError();
      needLogin.classList.add('hidden');
      loading.classList.remove('hidden');
      fileList.innerHTML = '';

      try {
        // ÂàóÂá∫ËØ•‚ÄúÁõÆÂΩï‚ÄùÁöÑÊâÄÊúâÂØπË±°
        const dirRef = ref(storage, `${grade}/`);
        const res = await listAll(dirRef);

        // Â≠êÊñá‰ª∂Â§π
        res.prefixes.forEach((folderRef) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <span>üìÅ ${folderRef.name}</span>
            <a class="link" href="javascript:void(0)">Open</a>
          `;
          li.querySelector('a').onclick = () => {
            currentGrade = `${grade}/${folderRef.name}`;
            currentGradeTitle.textContent = currentGrade;
            loadFilesForGrade(currentGrade);
          };
          fileList.appendChild(li);
        });

        // Êñá‰ª∂
        for (const itemRef of res.items) {
          const url = await getDownloadURL(itemRef);
          const li = document.createElement('li');
          li.innerHTML = `
            <span>üìÑ ${itemRef.name}</span>
            <a class="link" href="${url}" target="_blank" rel="noopener">Download</a>
          `;
          fileList.appendChild(li);
        }

        if (res.prefixes.length === 0 && res.items.length === 0) {
          const li = document.createElement('li');
          li.innerHTML = `<span class="muted">This folder is empty.</span>`;
          fileList.appendChild(li);
        }
      } catch (e) {
        // ÂæàÂ§ö 403 ‰ºöË¢´ÊµèËßàÂô®ÂΩìÊàê CORS ÊòæÁ§∫ÔºåËøôÈáåÊääÂèØËØª‰ø°ÊÅØÊèêÁ§∫Âá∫Êù•
        setError(
          "Failed to load files. If you see a 'CORS' message in console, it's usually:\n" +
          "‚Ä¢ Not signed in (please sign in first), or\n" +
          "‚Ä¢ Storage rules rejecting (read requires login), or\n" +
          "‚Ä¢ App Check enforced for Storage (turn OFF enforcement until integrated).\n\n" +
          "Details: " + (e.message || e.toString())
        );
      } finally {
        loading.classList.add('hidden');
      }
    }

    // ÁôªÂΩï/ÁôªÂá∫
    loginBtn.onclick = async () => {
      clearError();
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        setError("Sign-in failed: " + (e.message || e.toString()));
      }
    };
    logoutBtn.onclick = async () => {
      await signOut(auth);
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        userEmailEl.textContent = user.email || "";
        loginBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');

        // ÁÆ°ÁêÜÂëòÊùÉÈôêÔºöÊòæÁ§∫‰∏ä‰º†„ÄÅÊñ∞Âª∫Êñá‰ª∂Â§π
        const isAdmin = (user.email || "").toLowerCase() === ADMIN_EMAIL.toLowerCase();
        addFolderBtn.classList.toggle('hidden', !isAdmin);
        uploadBar.classList.toggle('hidden', !isAdmin);

        // ÈªòËÆ§ÁÇπÂºÄÁ¨¨‰∏Ä‰∏™Âπ¥Á∫ß
        if (!currentGrade) {
          currentGrade = gradeFolders[0];
          currentGradeTitle.textContent = currentGrade + " Grade";
          loadFilesForGrade(currentGrade);
        } else {
          loadFilesForGrade(currentGrade);
        }
      } else {
        userEmailEl.textContent = "";
        loginBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        addFolderBtn.classList.add('hidden');
        uploadBar.classList.add('hidden');
        fileList.innerHTML = "";
        currentGradeTitle.textContent = "Please sign in";
        needLogin.classList.remove('hidden');
      }
    });

    // AdminÔºöÊñ∞Â¢û‚ÄúÊñá‰ª∂Â§π‚ÄùÔºàStorage Êú¨Ë¥®Ê≤°ÊúâÁ©∫Êñá‰ª∂Â§πÊ¶ÇÂøµÔºåËøôÈáå‰ºöÂàõÂª∫‰∏Ä‰∏™Âç†‰ΩçÊñá‰ª∂Ôºâ
    addFolderBtn.onclick = async () => {
      const name = prompt("New folder name (e.g., '5th-Unit1'):");
      if (!name) return;
      try {
        const placeholderRef = ref(storage, `${name}/.keep`);
        await uploadBytes(placeholderRef, new Blob([""], { type: "text/plain"}));
        if (!gradeFolders.includes(name)) gradeFolders.push(name);
        renderGrades();
        alert("Folder created: " + name);
      } catch (e) {
        setError("Create folder failed: " + (e.message || e.toString()));
      }
    };

    // AdminÔºö‰∏ä‰º†
    chooseFileBtn.onclick = () => fileInput.click();
    fileInput.onchange = () => { chosenFile = fileInput.files?.[0] || null; uploadStatus.textContent = chosenFile ? chosenFile.name : ""; };
    uploadBtn.onclick = async () => {
      if (!chosenFile) { alert("Choose a file first."); return; }
      if (!currentGrade) { alert("Choose a folder first."); return; }
      try {
        uploadStatus.textContent = "Uploading...";
        const destRef = ref(storage, `${currentGrade}/${chosenFile.name}`);
        await uploadBytes(destRef, chosenFile);
        uploadStatus.textContent = "Upload done.";
        loadFilesForGrade(currentGrade);
      } catch (e) {
        setError("Upload failed: " + (e.message || e.toString()));
        uploadStatus.textContent = "";
      }
    };

    // ÂàùÂßãÂåñÂ∑¶‰æßÂπ¥Á∫ß
    renderGrades();
  </script>
</body>
</html>
